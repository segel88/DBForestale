
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheda di Rilievo Forestale</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8FBC8F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="assets/icons/icon-192x192.png">
    <style>
        .superficie-error {
            border: 2px solid #ff4444 !important;
            background-color: #fff5f5 !important;
        }
        
        .error-message {
            background-color: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }
        
        .superficie-error .cadastral-superficie-field {
            border-color: #ff4444 !important;
            background-color: #fff5f5 !important;
        }
    </style>
</head>
<body>
    <!-- Home Page -->
    <div id="home-page" class="home-container">
        <header class="home-header">
            <h1>DB Forestale</h1>
            <p>Sistema di gestione dati forestali</p>
        </header>

        <main class="home-main">
            <div class="home-buttons">
                <button type="button" id="new-project-btn" class="home-btn home-btn-primary">
                    <span class="btn-icon">üìã</span>
                    <span class="btn-text">Crea nuovo progetto</span>
                </button>
                
                <button type="button" id="load-project-btn" class="home-btn home-btn-secondary">
                    <span class="btn-icon">üìÅ</span>
                    <span class="btn-text">Carica progetto</span>
                </button>
                
                <button type="button" id="manage-projects-btn" class="home-btn home-btn-secondary">
                    <span class="btn-icon">üìä</span>
                    <span class="btn-text">Gestione progetti</span>
                </button>
                
                <button type="button" id="settings-btn" class="home-btn home-btn-secondary">
                    <span class="btn-icon">‚öôÔ∏è</span>
                    <span class="btn-text">Impostazioni</span>
                </button>
                
                <button type="button" id="guide-btn" class="home-btn home-btn-secondary">
                    <span class="btn-icon">‚ùì</span>
                    <span class="btn-text">Guida</span>
                </button>
            </div>
        </main>
    </div>

    <!-- Project Creation Modal -->
    <div id="project-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crea nuovo progetto</h2>
            </div>
            <div class="modal-body">
                <form id="project-form">
                    <div class="form-group">
                        <label for="project-name">Nome del progetto</label>
                        <input type="text" id="project-name" name="project-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-location">Location</label>
                        <input type="text" id="project-location" name="project-location" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-client">Committente</label>
                        <input type="text" id="project-client" name="project-client" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-authority">Ente di riferimento</label>
                        <input type="text" id="project-authority" name="project-authority" required>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" id="start-project-btn" class="modal-btn modal-btn-primary">Avvia il progetto</button>
                <button type="button" id="cancel-project-btn" class="modal-btn modal-btn-secondary">Annulla progetto</button>
            </div>
        </div>
    </div>

    <!-- Project Overview Page (initially hidden) -->
    <div id="project-page" class="project-container hidden">
        <header class="project-header">
            <h1>Progetto</h1>
            <button id="back-to-home-btn" class="back-btn">‚Üê Torna alla home</button>
        </header>

        <div class="project-details">
            <div class="project-info-card">
                <h2>Dettagli Progetto</h2>
                <div class="project-info">
                    <div class="info-item">
                        <label>Nome del progetto:</label>
                        <span id="display-project-name"></span>
                    </div>
                    <div class="info-item">
                        <label>Location:</label>
                        <span id="display-project-location"></span>
                    </div>
                    <div class="info-item">
                        <label>Committente:</label>
                        <span id="display-project-client"></span>
                    </div>
                    <div class="info-item">
                        <label>Ente di riferimento:</label>
                        <span id="display-project-authority"></span>
                    </div>
                </div>
            </div>

            <div class="particella-actions">
                <button type="button" id="add-particella-btn" class="btn btn-primary">
                    <span class="btn-icon">üìã</span>
                    Aggiungi particella
                </button>
            </div>

            <div class="particella-list">
                <h3>Particelle del Progetto</h3>
                <div class="particella-table-container">
                    <table class="particella-table">
                        <thead>
                            <tr>
                                <th>Particella</th>
                                <th>Sub. part.</th>
                                <th>Superficie (ha)</th>
                                <th>Specie</th>
                                <th>Intervento Programmato</th>
                                <th>Anno</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="particella-table-body">
                            <!-- Particella rows will be added here dynamically -->
                        </tbody>
                    </table>
                    <div id="empty-particelle-message" class="empty-message">
                        Nessuna particella ancora aggiunta al progetto
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Impostazioni - Header e Footer</h2>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="settings-tab active" data-tab="header">Header</button>
                    <button class="settings-tab" data-tab="footer">Footer</button>
                </div>
                
                <div id="header-settings" class="settings-content active">
                    <h3>Personalizza Header (parte superiore della pagina)</h3>
                    <div class="editor-toolbar">
                        <button type="button" onclick="formatText('bold')" title="Grassetto"><b>B</b></button>
                        <button type="button" onclick="formatText('italic')" title="Corsivo"><i>I</i></button>
                        <button type="button" onclick="formatText('underline')" title="Sottolineato"><u>U</u></button>
                        <select onchange="formatText('fontSize', this.value)">
                            <option value="">Dimensione</option>
                            <option value="12px">Piccolo</option>
                            <option value="14px">Normale</option>
                            <option value="16px">Grande</option>
                            <option value="20px">Molto grande</option>
                        </select>
                        <button type="button" onclick="formatText('justifyLeft')" title="Allinea a sinistra">‚óÑ</button>
                        <button type="button" onclick="formatText('justifyCenter')" title="Centra">‚ñ∫‚óÑ</button>
                        <button type="button" onclick="formatText('justifyRight')" title="Allinea a destra">‚ñ∫</button>
                    </div>
                    <div id="header-editor" class="rich-editor" contenteditable="true" placeholder="Scrivi qui il contenuto dell'header (es. logo, nome azienda, indirizzo...)">
                        <div style="text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 10px;">NOME AZIENDA</div>
                        <div style="text-align: center; font-size: 12px;">Via Example 123, 12345 Citt√† (PR) - Tel: 123.456.7890 - Email: info@azienda.it</div>
                    </div>
                </div>
                
                <div id="footer-settings" class="settings-content">
                    <h3>Personalizza Footer (parte inferiore della pagina)</h3>
                    <div class="editor-toolbar">
                        <button type="button" onclick="formatText('bold')" title="Grassetto"><b>B</b></button>
                        <button type="button" onclick="formatText('italic')" title="Corsivo"><i>I</i></button>
                        <button type="button" onclick="formatText('underline')" title="Sottolineato"><u>U</u></button>
                        <select onchange="formatText('fontSize', this.value)">
                            <option value="">Dimensione</option>
                            <option value="10px">Molto piccolo</option>
                            <option value="12px">Piccolo</option>
                            <option value="14px">Normale</option>
                        </select>
                        <button type="button" onclick="formatText('justifyLeft')" title="Allinea a sinistra">‚óÑ</button>
                        <button type="button" onclick="formatText('justifyCenter')" title="Centra">‚ñ∫‚óÑ</button>
                        <button type="button" onclick="formatText('justifyRight')" title="Allinea a destra">‚ñ∫</button>
                    </div>
                    <div id="footer-editor" class="rich-editor" contenteditable="true" placeholder="Scrivi qui il contenuto del footer (es. firma, data, timbro...)">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div>Tecnico: _________________________</div>
                            <div>Data: _________________________</div>
                        </div>
                        <div style="text-align: center; font-size: 10px; margin-top: 20px;">Documento generato con DB Forestale</div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" id="save-settings-btn" class="modal-btn modal-btn-primary">üíæ Salva impostazioni</button>
                <button type="button" id="cancel-settings-btn" class="modal-btn modal-btn-secondary">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Main Form (initially hidden) -->
    <div id="main-form" class="container hidden">
        <!-- Dynamic Print Header -->
        <div class="print-header-content"></div>
        
        <header class="form-header">
            <h1>SCHEDA DI RILIEVO</h1>
            <div class="db-key">Chiave db: <input type="text" id="chiave-db" maxlength="5" placeholder=""></div>
        </header>

        <form id="forestry-form">
            <!-- Sezione identificazione particella e caratteristiche stazionali -->
            <section class="form-section">
                <div class="two-column-layout">
                    <div class="inquadramento-box">
                        <div class="section-header">Inquadramento generale</div>
                        <div class="inquadramento-layout">
                            <div class="inquadramento-left">
                                <div class="inquadramento-row">
                                    <label for="particella">Particella (PF) n.</label>
                                    <input type="text" id="particella" name="particella" maxlength="3">
                                </div>
                                <div class="inquadramento-row">
                                    <label for="sottoparticella">Sottoparticella (SPF) n.</label>
                                    <input type="text" id="sottoparticella" name="sottoparticella" maxlength="2">
                                </div>
                                <div class="inquadramento-row">
                                    <label for="localita">Localit√†</label>
                                    <input type="text" id="localita" name="localita">
                                </div>
                            </div>
                            <div class="inquadramento-right">
                                <div class="inquadramento-row">
                                    <label for="superficie-particella">Superficie particella (ha)</label>
                                    <input type="text" id="superficie-particella" name="superficie-particella" readonly placeholder="0.0000">
                                </div>
                                <div class="inquadramento-row">
                                    <label for="superficie-sottoparticella">Superficie sottoparticella (ha)</label>
                                    <input type="text" pattern="[0-9]*\.?[0-9]{0,4}" max="999.9999" id="superficie-sottoparticella" name="superficie-sottoparticella" placeholder="0.0000">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="caratteristiche-box">
                        <div class="section-header">Caratteristiche stazionali</div>
                        <div class="caratteristiche-layout">
                            <div class="field-group">
                                <label for="esposizione">Esposizione</label>
                                <select id="esposizione" name="esposizione">
                                    <option value="">Seleziona...</option>
                                    <option value="N">N</option>
                                    <option value="NE">NE</option>
                                    <option value="E">E</option>
                                    <option value="SE">SE</option>
                                    <option value="S">S</option>
                                    <option value="SW">SW</option>
                                    <option value="W">W</option>
                                    <option value="NW">NW</option>
                                </select>
                            </div>
                            <div class="field-group">
                                <label for="altitudine">Altitudine (m)</label>
                                <input type="number" id="altitudine" name="altitudine" max="9999" step="1">
                            </div>
                            <div class="field-group">
                                <label for="pendenza">Pendenza (%)</label>
                                <div class="input-with-unit">
                                    <input type="number" step="1" max="99" id="pendenza" name="pendenza">
                                    <span class="unit">%</span>
                                </div>
                            </div>
                            <div class="field-group">
                                <label for="fertilita">Fertilit√†</label>
                                <select id="fertilita" name="fertilita">
                                    <option value="">Seleziona...</option>
                                    <option value="Scarsa">Scarsa</option>
                                    <option value="Bassa">Bassa</option>
                                    <option value="Media">Media</option>
                                    <option value="Alta">Alta</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Infrastrutture -->
            <section class="form-section">
                <div class="section-header">Infrastrutture forestali</div>
                <div class="infrastructure-container">
                    <div class="infrastructure-column">
                        <div class="infrastructure-items" id="infra-col-1">
                            <div class="field-group">
                                <label for="viabilita">Viabilit√† e imposti</label>
                                <div class="input-with-delete">
                                    <select id="viabilita" name="viabilita">
                                        <option value="">Seleziona...</option>
                                        <option value="Strada camionabile principale">Strada camionabile principale</option>
                                        <option value="Strada camionabile secondaria">Strada camionabile secondaria</option>
                                        <option value="Strada trattorabile">Strada trattorabile</option>
                                        <option value="Pista camionabile">Pista camionabile</option>
                                        <option value="Pista principale per trattori">Pista principale per trattori</option>
                                        <option value="Pista secondaria per trattori">Pista secondaria per trattori</option>
                                        <option value="Linee di esbosco">Linee di esbosco</option>
                                        <option value="Imposto permanente">Imposto permanente</option>
                                        <option value="Imposto temporaneo">Imposto temporaneo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="infrastructure-column">
                        <div class="infrastructure-items" id="infra-col-2"></div>
                    </div>
                    <div class="infrastructure-column">
                        <div class="infrastructure-items" id="infra-col-3"></div>
                    </div>
                </div>
                <button type="button" id="add-infrastruttura-btn" class="add-row-btn add-infrastruttura-btn">+ Aggiungi infrastruttura</button>
            </section>

            <!-- Caratterizzazione della particella -->
            <section class="form-section">
                <div class="section-header">Caratterizzazione della particella</div>
                <div class="caratterizzazione-layout">
                    <div class="caratterizzazione-row-1">
                        <div class="field-group">
                            <label for="forma-governo">Forma di governo</label>
                            <select id="forma-governo" name="forma-governo">
                                <option value="">Seleziona...</option>
                                <option value="Ceduo">Ceduo</option>
                                <option value="Fustaia">Fustaia</option>
                                <option value="Neoformazione">Neoformazione</option>
                                <option value="Non definita">Non definita</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="composizione">Composizione</label>
                            <select id="composizione" name="composizione">
                                <option value="">Seleziona...</option>
                                <option value="Puro">Puro</option>
                                <option value="A prevalenza">A prevalenza</option>
                                <option value="Misto">Misto</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="grado-evolutivo">Grado evolutivo</label>
                            <select id="grado-evolutivo" name="grado-evolutivo">
                                <option value="">Seleziona...</option>
                                <option value="Ceduo a regime">Ceduo a regime</option>
                                <option value="Ceduo invecchiato">Ceduo invecchiato</option>
                                <option value="Fustaia giovane">Fustaia giovane</option>
                                <option value="Fustaia adulta">Fustaia adulta</option>
                                <option value="Fustaia matura">Fustaia matura</option>
                                <option value="Novelletto">Novelletto</option>
                                <option value="Perticaia">Perticaia</option>
                                <option value="Posticcia">Posticcia</option>
                                <option value="Spessina">Spessina</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="tipo-colturale">Tipo colturale</label>
                            <select id="tipo-colturale" name="tipo-colturale">
                                <option value="">Seleziona...</option>
                                <option value="Ceduo semplice">Ceduo semplice</option>
                                <option value="Ceduo intensamente matricinato">Ceduo intensamente matricinato</option>
                                <option value="Ceduo composto">Ceduo composto</option>
                                <option value="Ceduo a sterzo">Ceduo a sterzo</option>
                                <option value="Ceduo coniferato">Ceduo coniferato</option>
                                <option value="Fustaia coetanea">Fustaia coetanea</option>
                                <option value="Fustaia transitoria">Fustaia transitoria</option>
                                <option value="Fustaia irregolare">Fustaia irregolare</option>
                                <option value="Fustaia disetanea">Fustaia disetanea</option>
                                <option value="Fustaia su ceduo">Fustaia su ceduo</option>
                            </select>
                        </div>
                    </div>
                    <div class="caratterizzazione-row-2">
                        <div class="field-group">
                            <label for="tipo-forestale">Tipo forestale</label>
                            <select id="tipo-forestale" name="tipo-forestale">
                        <option value="">Seleziona...</option>
                        <option value="1.1. Lecceta tipica a Viburnum tinus">1.1. Lecceta tipica a Viburnum tinus</option>
                        <option value="1.2. Lecceta di transizione a boschi di caducifoglie">1.2. Lecceta di transizione a boschi di caducifoglie</option>
                        <option value="1.3. Orno-lecceta con roverella delle zone interne">1.3. Orno-lecceta con roverella delle zone interne</option>
                        <option value="1.4. Lecceta rupicola relitta submontana e montana">1.4. Lecceta rupicola relitta submontana e montana</option>
                        <option value="2.1. Macchia media mesoditerranea">2.1. Macchia media mesoditerranea</option>
                        <option value="2.2. Macchia bassa mesomediterranea">2.2. Macchia bassa mesomediterranea</option>
                        <option value="2.3. Macchia termomediterranea">2.3. Macchia termomediterranea</option>
                        <option value="2.4. Macchia rupestre a Olea europaea sylvestris ed Euphorbia dendroides">2.4. Macchia rupestre a Olea europaea sylvestris ed Euphorbia dendroides</option>
                        <option value="2.5. Ginepreto dunale a Juniperus macrocarpa e J. phoenicea">2.5. Ginepreto dunale a Juniperus macrocarpa e J. phoenicea</option>
                        <option value="2.6. Ginepreto rupestre a Juniperus phoenicea">2.6. Ginepreto rupestre a Juniperus phoenicea</option>
                        <option value="2.7. Boscaglia di consolidamento dunale a tamerici">2.7. Boscaglia di consolidamento dunale a tamerici</option>
                        <option value="3.1. Sughereta mista sopra ceduo di leccio e altre sempreverdi">3.1. Sughereta mista sopra ceduo di leccio e altre sempreverdi</option>
                        <option value="3.2. Sughereta mista sopra ceduo di sempreverdi e caducifoglie">3.2. Sughereta mista sopra ceduo di sempreverdi e caducifoglie</option>
                        <option value="3.3. Sughereta specializzata">3.3. Sughereta specializzata</option>
                        <option value="4.1. Pineta costiera di pino d'Aleppo">4.1. Pineta costiera di pino d'Aleppo</option>
                        <option value="4.2. Pineta di pino d'Aleppo di rimboschimento">4.2. Pineta di pino d'Aleppo di rimboschimento</option>
                        <option value="5.1. Pineta dunale mesomediterranea di pino domestico">5.1. Pineta dunale mesomediterranea di pino domestico</option>
                        <option value="5.2. Pineta dunale termomediterranea di pino domestico">5.2. Pineta dunale termomediterranea di pino domestico</option>
                        <option value="5.3. Pineta dunale di pino domestico a leccio">5.3. Pineta dunale di pino domestico a leccio</option>
                        <option value="5.4. Pineta planiziale mesoigrofila di pino domestico">5.4. Pineta planiziale mesoigrofila di pino domestico</option>
                        <option value="5.5. Pineta collinare di pino domestico a eriche e cisti">5.5. Pineta collinare di pino domestico a eriche e cisti</option>
                        <option value="5.6. Pineta collinare di pino domestico a roverella con arbusti del Pruneto">5.6. Pineta collinare di pino domestico a roverella con arbusti del Pruneto</option>
                        <option value="6.1. Pineta di clima suboceanico di pino marittimo a Ulex europaeus">6.1. Pineta di clima suboceanico di pino marittimo a Ulex europaeus</option>
                        <option value="6.2. Pineta sopramediterranea di pino marittimo">6.2. Pineta sopramediterranea di pino marittimo</option>
                        <option value="6.3. Pineta mediterranea di pino marittimo su macchia acidofila">6.3. Pineta mediterranea di pino marittimo su macchia acidofila</option>
                        <option value="6.4. Pineta costiera di pino marittimo">6.4. Pineta costiera di pino marittimo</option>
                        <option value="6.5. Pineta di pino marittimo su ofioliti">6.5. Pineta di pino marittimo su ofioliti</option>
                        <option value="7.1. Cipresseta a roverella e Spartium junceum">7.1. Cipresseta a roverella e Spartium junceum</option>
                        <option value="7.2. Cipresseta su gramineto xerofilo">7.2. Cipresseta su gramineto xerofilo</option>
                        <option value="8.1. Alneto igrofilo e mesoigrofilo di ontano nero e frassino meridionale">8.1. Alneto igrofilo e mesoigrofilo di ontano nero e frassino meridionale</option>
                        <option value="8.2. Bosco interdunale di pioppi con farnia e frassino meridionale">8.2. Bosco interdunale di pioppi con farnia e frassino meridionale</option>
                        <option value="8.3 Querco-carpineto extrazonale di farnia.">8.3 Querco-carpineto extrazonale di farnia.</option>
                        <option value="9.1. Saliceto e pioppeto ripario">9.1. Saliceto e pioppeto ripario</option>
                        <option value="9.2 Alneto ripario di ontano nero">9.2 Alneto ripario di ontano nero</option>
                        <option value="10.1. Querceto mesotermofilo di roverella a Rosa sempervirens">10.1. Querceto mesotermofilo di roverella a Rosa sempervirens</option>
                        <option value="10.2. Querceto mesofilo di roverella e cerro">10.2. Querceto mesofilo di roverella e cerro</option>
                        <option value="10.3. Querceto mesoxerofilo di roverella a Cytisus sessilifolius">10.3. Querceto mesoxerofilo di roverella a Cytisus sessilifolius</option>
                        <option value="10.4. Querceto acidofilo di roverella a cerro">10.4. Querceto acidofilo di roverella a cerro</option>
                        <option value="10.5. Querceto termofilo di roverella con leccio e cerro">10.5. Querceto termofilo di roverella con leccio e cerro</option>
                        <option value="11.1. Cerreta eutrofica ad Acer opalus s.l.">11.1. Cerreta eutrofica ad Acer opalus s.l.</option>
                        <option value="11.2.Cerreta mesofila collinare">11.2.Cerreta mesofila collinare</option>
                        <option value="11.3. Cerreta mesoxerofila">11.3. Cerreta mesoxerofila</option>
                        <option value="11.4. Cerreta acidofila montana">11.4. Cerreta acidofila montana</option>
                        <option value="11.5.Cerreta acidofila dei terrazzi a paleosuoli">11.5.Cerreta acidofila dei terrazzi a paleosuoli</option>
                        <option value="11.6. Cerreta acidofila submediterranea a eriche">11.6. Cerreta acidofila submediterranea a eriche</option>
                        <option value="11.7. Cerreta mesofila planiziale">11.7. Cerreta mesofila planiziale</option>
                        <option value="11.8. Cerreta termoigrofila mediterranea">11.8. Cerreta termoigrofila mediterranea</option>
                        <option value="11.9 Querceto di cerro e farnetto a Pulicaria odora">11.9 Querceto di cerro e farnetto a Pulicaria odora</option>
                        <option value="12.1. Carpino-querceto mesofilo di cerro con rovere">12.1. Carpino-querceto mesofilo di cerro con rovere</option>
                        <option value="12.2. Querceto acidofilo di rovere e cerro">12.2. Querceto acidofilo di rovere e cerro</option>
                        <option value="12.3. Carpineto misto collinare (-submontano) a cerro">12.3. Carpineto misto collinare (-submontano) a cerro</option>
                        <option value="13.1. Ostrieto pioniero dei calcari duri delle Apuane">13.1. Ostrieto pioniero dei calcari duri delle Apuane</option>
                        <option value="13.2. Ostrieto mesofilo a Sesleria argentea delle Apuane">13.2. Ostrieto mesofilo a Sesleria argentea delle Apuane</option>
                        <option value="13.3. Ostrieto pioniero delle balze marnoso-arenacee appenniniche">13.3. Ostrieto pioniero delle balze marnoso-arenacee appenniniche</option>
                        <option value="13.4. Ostrieto delle aree calanchive delle alte valli dell'Arno e del Tevere">13.4. Ostrieto delle aree calanchive delle alte valli dell'Arno e del Tevere</option>
                        <option value="13.5. Ostrieto termofilo dei calcari marnosi ad Asparagus acutifolius">13.5. Ostrieto termofilo dei calcari marnosi ad Asparagus acutifolius</option>
                        <option value="13.6. Ostrieto mesofilo dei substrati silicatici">13.6. Ostrieto mesofilo dei substrati silicatici</option>
                        <option value="14.1. Castagneto mesofilo su arenaria">14.1. Castagneto mesofilo su arenaria</option>
                        <option value="14.2. Castagneto mesotrofico su rocce vulcaniche del Monte Amiata">14.2. Castagneto mesotrofico su rocce vulcaniche del Monte Amiata</option>
                        <option value="14.3. Castagneto acidofilo">14.3. Castagneto acidofilo</option>
                        <option value="14.4. Castagneto neutrofilo su rocce calcaree e scisti marnosi">14.4. Castagneto neutrofilo su rocce calcaree e scisti marnosi</option>
                        <option value="15.1. Robinieto d'impianto">15.1. Robinieto d'impianto</option>
                        <option value="16.1. Betuleto misto">16.1. Betuleto misto</option>
                        <option value="17.1. Alneto autoctono di ontano bianco">17.1. Alneto autoctono di ontano bianco</option>
                        <option value="17.2. Alneto d'impianto di ontano napoletano">17.2. Alneto d'impianto di ontano napoletano</option>
                        <option value="18.1. Pineta eutrofica (acidofila) di pino nero">18.1. Pineta eutrofica (acidofila) di pino nero</option>
                        <option value="18.2. Pineta neutro-acidoclina di pino nero">18.2. Pineta neutro-acidoclina di pino nero</option>
                        <option value="18.3. Pineta neutro-basifila di pino nero">18.3. Pineta neutro-basifila di pino nero</option>
                        <option value="19. Impianti di douglasia">19. Impianti di douglasia</option>
                        <option value="20.1. Pteridieto">20.1. Pteridieto</option>
                        <option value="20.2. Pruneto">20.2. Pruneto</option>
                        <option value="20.3. Ginestreto collinare di Spartium junceum">20.3. Ginestreto collinare di Spartium junceum</option>
                        <option value="20.4. Ginepreto di Juniperus communis">20.4. Ginepreto di Juniperus communis</option>
                        <option value="20.5. Ginestreto Cytisus scoparius">20.5. Ginestreto Cytisus scoparius</option>
                        <option value="20.6. Calluneto di quota">20.6. Calluneto di quota</option>
                        <option value="21.1. Abetina altimontana di origine artificiale">21.1. Abetina altimontana di origine artificiale</option>
                        <option value="21.2. Abetina montana di origine artificiale">21.2. Abetina montana di origine artificiale</option>
                        <option value="21.3. Abetina sotto quota di origine aritificiale">21.3. Abetina sotto quota di origine aritificiale</option>
                        <option value="21.4. Abetina mista autoctona del monte Amiata">21.4. Abetina mista autoctona del monte Amiata</option>
                        <option value="21.5. Piceo-abieteto autoctono con faggio dell'Abetone">21.5. Piceo-abieteto autoctono con faggio dell'Abetone</option>
                        <option value="22.1. Faggeta eutrofica a dentarie">22.1. Faggeta eutrofica a dentarie</option>
                        <option value="22.2. Faggeta appenninica mesotrofica a Geranium nodosum e Luzula nivea">22.2. Faggeta appenninica mesotrofica a Geranium nodosum e Luzula nivea</option>
                        <option value="22.3. Faggeta oligotrofica a Luzula pedemontana, Luzula nivea e Festuca heterophylla">22.3. Faggeta oligotrofica a Luzula pedemontana, Luzula nivea e Festuca heterophylla</option>
                        <option value="22.4. Aceri-faggeto appenninico di quota">22.4. Aceri-faggeto appenninico di quota</option>
                        <option value="22.5. Faggeta cespugliosa di vetta">22.5. Faggeta cespugliosa di vetta</option>
                        <option value="22.6. Faggeta apuana a Sesleria argentea">22.6. Faggeta apuana a Sesleria argentea</option>
                        <option value="22.7. Faggeta amiatina inferiore">22.7. Faggeta amiatina inferiore</option>
                        <option value="22.8. Faggeta amiatina superiore ad Adenostyles australis">22.8. Faggeta amiatina superiore ad Adenostyles australis</option>
                        <option value="22.9. Aceri-frassineto">22.9. Aceri-frassineto</option>
                        <option value="23.1. Ontano napoletano">23.1. Ontano napoletano</option>
                        <option value="23.2. Cedro dell'Atlante">23.2. Cedro dell'Atlante</option>
                        <option value="23.4. Cipresso dell'Arizona">23.4. Cipresso dell'Arizona</option>
                        <option value="23.5. Larice giapponese">23.5. Larice giapponese</option>
                        <option value="23.6. Larice europeo">23.6. Larice europeo</option>
                        <option value="23.7. Quercia rossa">23.7. Quercia rossa</option>
                        <option value="23.8. Abete greco">23.8. Abete greco</option>
                        <option value="23.9. Pino strobo">23.9. Pino strobo</option>
                        <option value="23.10. Pino eccelso">23.10. Pino eccelso</option>
                        <option value="23.11. Eucalipti">23.11. Eucalipti</option>
                    </select>
                        </div>
                        <div class="field-group">
                            <label for="destinazione">Destinazione</label>
                            <select id="destinazione" name="destinazione">
                                <option value="">Seleziona...</option>
                                <option value="Produttiva">Produttiva</option>
                                <option value="Paesaggistica">Paesaggistica</option>
                                <option value="Naturalistica">Naturalistica</option>
                                <option value="Scientifica">Scientifica</option>
                            </select>
                        </div>
                    </div>
                    <div class="caratterizzazione-row-3">
                        <div class="field-group">
                            <label for="compresa-forestale">Compresa forestale</label>
                            <input type="text" id="compresa-forestale" name="compresa-forestale">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Descrizione del soprassuolo -->
            <section class="form-section">
                <div class="section-header">Descrizione del soprassuolo</div>
                
                <!-- Tabella specie -->
                <div class="species-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Specie</th>
                                <th>%</th>
                                <th>d (cm)</th>
                                <th>h (m)</th>
                                <th>V</th>
                                <th>Vt/ha (mc)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <select>
                                        <option value="">Seleziona specie...</option>
                                        <option value="Abete bianco (Abies alba)">Abete bianco <em>(Abies alba)</em></option>
                                        <option value="Abete rosso (Picea abies)">Abete rosso <em>(Picea abies)</em></option>
                                        <option value="Acero campestre (Acer campestre)">Acero campestre <em>(Acer campestre)</em></option>
                                        <option value="Acero di monte (Acer pseudoplatanus)">Acero di monte <em>(Acer pseudoplatanus)</em></option>
                                        <option value="Acero opalo (Acer opalus)">Acero opalo <em>(Acer opalus)</em></option>
                                        <option value="Acero riccio (Acer lobelii)">Acero riccio <em>(Acer lobelii)</em></option>
                                        <option value="Acero tribolo (Acer tataricum)">Acero tribolo <em>(Acer tataricum)</em></option>
                                        <option value="Ailanto (Ailanthus altissima)">Ailanto <em>(Ailanthus altissima)</em></option>
                                        <option value="Betulla (Betula pendula)">Betulla <em>(Betula pendula)</em></option>
                                        <option value="Carpino bianco (Carpinus betulus)">Carpino bianco <em>(Carpinus betulus)</em></option>
                                        <option value="Carpino nero (Ostrya carpinifolia)">Carpino nero <em>(Ostrya carpinifolia)</em></option>
                                        <option value="Castagno (Castanea sativa)">Castagno <em>(Castanea sativa)</em></option>
                                        <option value="Cedro dell'Atlante (Cedrus atlantica)">Cedro dell'Atlante <em>(Cedrus atlantica)</em></option>
                                        <option value="Cedro deodara (Cedrus deodara)">Cedro deodara <em>(Cedrus deodara)</em></option>
                                        <option value="Cedro del Libano (Cedrus libani)">Cedro del Libano <em>(Cedrus libani)</em></option>
                                        <option value="Cerro (Quercus cerris)">Cerro <em>(Quercus cerris)</em></option>
                                        <option value="Chamaecyparis (Chamaecyparis sp)">Chamaecyparis <em>(Chamaecyparis sp)</em></option>
                                        <option value="Ciavardello (Quercus robur)">Ciavardello <em>(Quercus robur)</em></option>
                                        <option value="Ciliegio (Prunus avium)">Ciliegio <em>(Prunus avium)</em></option>
                                        <option value="Cipresso comune (Cupressus sempervirens)">Cipresso comune <em>(Cupressus sempervirens)</em></option>
                                        <option value="Cipresso dell'Arizona (Cupressus arizonica)">Cipresso dell'Arizona <em>(Cupressus arizonica)</em></option>
                                        <option value="Cipresso di Monterey (Cupressus macrocarpa)">Cipresso di Monterey <em>(Cupressus macrocarpa)</em></option>
                                        <option value="Corbezzolo (Arbutus unedo)">Corbezzolo <em>(Arbutus unedo)</em></option>
                                        <option value="Douglasia (Pseudotsuga menziesii)">Douglasia <em>(Pseudotsuga menziesii)</em></option>
                                        <option value="Faggio (Fagus sylvatica)">Faggio <em>(Fagus sylvatica)</em></option>
                                        <option value="Farnetto (Fraxinus ornus)">Farnetto <em>(Fraxinus ornus)</em></option>
                                        <option value="Farnia (Fraxinus excelsior)">Farnia <em>(Fraxinus excelsior)</em></option>
                                        <option value="Frassino maggiore (Fraxinus angustifolia)">Frassino maggiore <em>(Fraxinus angustifolia)</em></option>
                                        <option value="Frassino ossifillo (Fraxinus oxycarpa)">Frassino ossifillo <em>(Fraxinus oxycarpa)</em></option>
                                        <option value="Ippocastano (Aesculus hippocastanum)">Ippocastano <em>(Aesculus hippocastanum)</em></option>
                                        <option value="Leccio (Quercus ilex)">Leccio <em>(Quercus ilex)</em></option>
                                        <option value="Nocciolo (Corylus avellana)">Nocciolo <em>(Corylus avellana)</em></option>
                                        <option value="Noce (Juglans regia)">Noce <em>(Juglans regia)</em></option>
                                        <option value="Ontano bianco (Alnus incana)">Ontano bianco <em>(Alnus incana)</em></option>
                                        <option value="Ontano napoletano (Alnus cordata)">Ontano napoletano <em>(Alnus cordata)</em></option>
                                        <option value="Ontano nero (Alnus glutinosa)">Ontano nero <em>(Alnus glutinosa)</em></option>
                                        <option value="Orniello (Fraxinus ornus)">Orniello <em>(Fraxinus ornus)</em></option>
                                        <option value="Pino d'Aleppo (Pinus halepensis)">Pino d'Aleppo <em>(Pinus halepensis)</em></option>
                                        <option value="Pino domestico (Pinus pinea)">Pino domestico <em>(Pinus pinea)</em></option>
                                        <option value="Pino insigne (Pinus radiata)">Pino insigne <em>(Pinus radiata)</em></option>
                                        <option value="Pino loricato (Pinus heldreichii)">Pino loricato <em>(Pinus heldreichii)</em></option>
                                        <option value="Pino marittimo (Pinus pinaster)">Pino marittimo <em>(Pinus pinaster)</em></option>
                                        <option value="Pino nero (Pinus nigra)">Pino nero <em>(Pinus nigra)</em></option>
                                        <option value="Pino silvestre (Pinus sylvestris)">Pino silvestre <em>(Pinus sylvestris)</em></option>
                                        <option value="Pioppo bianco (Populus alba)">Pioppo bianco <em>(Populus alba)</em></option>
                                        <option value="Pioppo cinerino (Populus cinerea)">Pioppo cinerino <em>(Populus cinerea)</em></option>
                                        <option value="Pioppo nero (Populus nigra)">Pioppo nero <em>(Populus nigra)</em></option>
                                        <option value="Pioppo tremulo (Populus tremula)">Pioppo tremulo <em>(Populus tremula)</em></option>
                                        <option value="Robinia (Robinia pseudoacacia)">Robinia <em>(Robinia pseudoacacia)</em></option>
                                        <option value="Rovere (Quercus robur)">Rovere <em>(Quercus robur)</em></option>
                                        <option value="Roverella (Quercus petraea)">Roverella <em>(Quercus petraea)</em></option>
                                        <option value="Salice (Salix spp)">Salice <em>(Salix spp)</em></option>
                                        <option value="Sorbo degli uccellatori (Sorbus aucuparia)">Sorbo degli uccellatori <em>(Sorbus aucuparia)</em></option>
                                        <option value="Sorbo domestico (Sorbus domestica)">Sorbo domestico <em>(Sorbus domestica)</em></option>
                                        <option value="Sughera (Quercus suber)">Sughera <em>(Quercus suber)</em></option>
                                        <option value="Tasso (Taxus baccata)">Tasso <em>(Taxus baccata)</em></option>
                                        <option value="Thuja (Thuja occidentalis)">Thuja <em>(Thuja occidentalis)</em></option>
                                        <option value="Tiglio (Tilia cordata)">Tiglio <em>(Tilia cordata)</em></option>
                                    </select>
                                </td>
                                <td><input type="number" step="1" max="99" class="no-spinner"></td>
                                <td><input type="number" step="1" max="999" class="no-spinner diameter-field"></td>
                                <td><input type="number" step="1" max="999" class="no-spinner height-field"></td>
                                <td><input type="number" step="0.01" max="9999.99" readonly class="calculated-field volume-field"></td>
                                <td><input type="number" step="0.01" readonly class="calculated-field volume-per-hectare-field"></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" id="add-species" class="add-row-btn">+ Aggiungi specie</button>
                </div>

                <div class="soprassuolo-layout">
                    <div class="inquadramento-row">
                        <label for="anno-rilievo">Anno rilievo</label>
                        <input type="number" id="anno-rilievo" name="anno-rilievo" min="1900" max="9999" step="1">
                    </div>
                    <div class="inquadramento-row">
                        <label for="piante-ettaro">Piante ad ettaro</label>
                        <input type="number" id="piante-ettaro" name="piante-ettaro" max="999999" step="1">
                    </div>
                    <div class="inquadramento-row">
                        <label for="eta-soprassuolo">Et√†</label>
                        <input type="number" id="eta-soprassuolo" name="eta-soprassuolo" max="999" step="1">
                    </div>
                    <div class="inquadramento-row">
                        <label for="copertura">Copertura (%)</label>
                        <input type="number" step="1" max="100" id="copertura" name="copertura">
                    </div>
                    <div class="inquadramento-row">
                        <label for="volume-totale">Volume totale (mc)</label>
                        <input type="number" step="0.01" max="9999.99" id="volume-totale" name="volume-totale" readonly class="calculated-field volume-total-field">
                    </div>
                    <div class="inquadramento-row">
                        <label for="imd">Imd</label>
                        <input type="number" step="0.1" max="99.9" id="imd" name="imd" readonly class="calculated-field">
                    </div>
                    <div class="inquadramento-row">
                        <label for="imh">Imh</label>
                        <input type="number" step="0.1" max="99.9" id="imh" name="imh" readonly class="calculated-field">
                    </div>
                    <div class="inquadramento-row">
                        <label for="imv">Imv</label>
                        <input type="number" step="0.1" max="99.9" id="imv" name="imv" readonly class="calculated-field">
                    </div>
                </div>
            </section>

            <!-- Registro interventi -->
            <section class="form-section">
                <div class="section-header">Registro interventi</div>
                <div class="ultimo-intervento-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Ultimo intervento effettuato</th>
                                <th>Anno</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <select id="ultimo-intervento" name="ultimo-intervento">
                                        <option value="">Seleziona intervento...</option>
                                        <option value="Conversione a ceduo">Conversione a ceduo</option>
                                        <option value="Diradamento dal basso">Diradamento dal basso</option>
                                        <option value="Diradamento del ceduo">Diradamento del ceduo</option>
                                        <option value="Diradamento geometrico">Diradamento geometrico</option>
                                        <option value="Diradamento selettivo">Diradamento selettivo</option>
                                        <option value="Manutenzione attorno manufatto">Manutenzione attorno manufatto</option>
                                        <option value="Manutenzione idraulica">Manutenzione idraulica</option>
                                        <option value="Manutenzione lungo viabilit√†">Manutenzione lungo viabilit√†</option>
                                        <option value="Recupero dell'uso agricolo storico del suolo">Recupero dell'uso agricolo storico del suolo</option>
                                        <option value="Sfollo e spalcatura">Sfollo e spalcatura</option>
                                        <option value="Sostituzione di specie">Sostituzione di specie</option>
                                        <option value="Taglio a scelta">Taglio a scelta</option>
                                        <option value="Taglio della fustaia su ceduo">Taglio della fustaia su ceduo</option>
                                        <option value="Taglio del ceduo a sterzo">Taglio del ceduo a sterzo</option>
                                        <option value="Taglio del ceduo composto">Taglio del ceduo composto</option>
                                        <option value="Taglio del ceduo coniferato">Taglio del ceduo coniferato</option>
                                        <option value="Taglio del ceduo intensamente matricinato">Taglio del ceduo intensamente matricinato</option>
                                        <option value="Taglio del ceduo semplice con rilascio di matricine">Taglio del ceduo semplice con rilascio di matricine</option>
                                        <option value="Taglio di avviamento all'alto fusto">Taglio di avviamento all'alto fusto</option>
                                        <option value="Taglio raso della fustaia con rimboschimento artificiale">Taglio raso della fustaia con rimboschimento artificiale</option>
                                        <option value="Taglio saltuario">Taglio saltuario</option>
                                        <option value="Trasformazione da terreno saldo a periodica lavorazione">Trasformazione da terreno saldo a periodica lavorazione</option>
                                        <option value="Altro: dettagliato in descrizione">Altro: dettagliato in descrizione</option>
                                    </select>
                                </td>
                                <td><input type="number" id="ultimo-intervento-anno" name="ultimo-intervento-anno" min="1900" max="2050"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="intervention-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Intervento programmato</th>
                                <th>Superficie (ha)</th>
                                <th>Anno</th>
                                <th>Et√†</th>
                                <th>Provv (mc)</th>
                                <th>Ripresa (mc)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <select>
                                        <option value="">Seleziona intervento...</option>
                                        <option value="Conversione a ceduo">Conversione a ceduo</option>
                                        <option value="Diradamento dal basso">Diradamento dal basso</option>
                                        <option value="Diradamento del ceduo">Diradamento del ceduo</option>
                                        <option value="Diradamento geometrico">Diradamento geometrico</option>
                                        <option value="Diradamento selettivo">Diradamento selettivo</option>
                                        <option value="Manutenzione attorno manufatto">Manutenzione attorno manufatto</option>
                                        <option value="Manutenzione idraulica">Manutenzione idraulica</option>
                                        <option value="Manutenzione lungo viabilit√†">Manutenzione lungo viabilit√†</option>
                                        <option value="Recupero dell'uso agricolo storico del suolo">Recupero dell'uso agricolo storico del suolo</option>
                                        <option value="Sfollo e spalcatura">Sfollo e spalcatura</option>
                                        <option value="Sostituzione di specie">Sostituzione di specie</option>
                                        <option value="Taglio a scelta">Taglio a scelta</option>
                                        <option value="Taglio della fustaia su ceduo">Taglio della fustaia su ceduo</option>
                                        <option value="Taglio del ceduo a sterzo">Taglio del ceduo a sterzo</option>
                                        <option value="Taglio del ceduo composto">Taglio del ceduo composto</option>
                                        <option value="Taglio del ceduo coniferato">Taglio del ceduo coniferato</option>
                                        <option value="Taglio del ceduo intensamente matricinato">Taglio del ceduo intensamente matricinato</option>
                                        <option value="Taglio del ceduo semplice con rilascio di matricine">Taglio del ceduo semplice con rilascio di matricine</option>
                                        <option value="Taglio di avviamento all'alto fusto">Taglio di avviamento all'alto fusto</option>
                                        <option value="Taglio raso della fustaia con rimboschimento artificiale">Taglio raso della fustaia con rimboschimento artificiale</option>
                                        <option value="Taglio saltuario">Taglio saltuario</option>
                                        <option value="Trasformazione da terreno saldo a periodica lavorazione">Trasformazione da terreno saldo a periodica lavorazione</option>
                                        <option value="Altro: dettagliato in descrizione">Altro: dettagliato in descrizione</option>
                                    </select>
                                </td>
                                <td><input type="number" step="0.0001" max="999.9999" class="intervention-superficie-field"></td>
                                <td><input type="number" min="1900" max="2050" class="intervention-anno-field"></td>
                                <td><input type="number" readonly class="calculated-field intervention-eta-field"></td>
                                <td><input type="number" step="0.01" max="9999.99" readonly class="calculated-field intervention-provv-field"></td>
                                <td><input type="number" step="0.01" max="9999.99" readonly class="calculated-field intervention-ripresa-field"></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="row">
                    <button type="button" id="add-intervention" class="add-row-btn">+ Aggiungi intervento</button>
                    <div class="row-separator"></div>
                    <div class="field-group inline-field">
                        <label for="intensita-intervento">Intensit√† intervento</label>
                        <input type="number" step="1" max="99" id="intensita-intervento" name="intensita-intervento">
                    </div>
                    <div class="row-separator"></div>
                    <div class="field-group">
                        <label for="autorizzazione">
                            <input type="checkbox" id="autorizzazione" name="autorizzazione">
                            Autorizzazione
                        </label>
                    </div>
                    <div class="field-group">
                        <label for="deroga">
                            <input type="checkbox" id="deroga" name="deroga">
                            Deroga al regolamento
                        </label>
                    </div>
                </div>
            </section>

            <!-- Riferimenti catastali -->
            <section class="form-section">
                <div class="section-header">Riferimenti catastali</div>
                <div class="cadastral-container">
                    <div class="cadastral-column">
                        <div class="cadastral-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Comune</th>
                                        <th>Foglio</th>
                                        <th>Part</th>
                                        <th>Sup. (ha)</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="cadastral-left-tbody">
                                    <tr>
                                        <td><input type="text"></td>
                                        <td><input type="text"></td>
                                        <td><input type="text"></td>
                                        <td><input type="number" step="0.01" class="cadastral-superficie-field"></td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button type="button" id="add-cadastral" class="add-row-btn">+ Aggiungi particella</button>
                        </div>
                    </div>
                    <div class="cadastral-column">
                        <div class="cadastral-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Comune</th>
                                        <th>Foglio</th>
                                        <th>Part</th>
                                        <th>Sup. (ha)</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="cadastral-right-tbody">
                                    <!-- Right column starts empty, populated when left column has 4+ rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Descrizione -->
            <section class="form-section">
                <div class="field-group full-width">
                    <label for="descrizione">Descrizione</label>
                    <textarea id="descrizione" name="descrizione" rows="6" placeholder="Inserire qui eventuali note descrittive..."></textarea>
                </div>
            </section>

            <!-- Pulsanti di controllo -->
            <div class="form-actions">
                <button type="button" id="save-btn" class="btn btn-primary">üíæ Salva</button>
                <button type="button" id="load-btn" class="btn btn-secondary">üìÅ Carica</button>
                <button type="button" id="export-btn" class="btn btn-secondary">üì§ Esporta</button>
                <button type="reset" class="btn btn-danger">üóëÔ∏è Cancella tutto</button>
            </div>
        </form>
        
        <!-- Dynamic Print Footer -->
        <div class="print-footer-content"></div>
    </div>

    <script>
        // Page management
        function showHomePage() {
            document.getElementById('home-page').classList.remove('hidden');
            document.getElementById('project-page').classList.add('hidden');
            document.getElementById('main-form').classList.add('hidden');
        }

        function showProjectPage() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('project-page').classList.remove('hidden');
            document.getElementById('main-form').classList.add('hidden');
            loadProjectData();
        }

        function showMainForm() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('project-page').classList.add('hidden');
            document.getElementById('main-form').classList.remove('hidden');
            
            // Load specific particella data when editing
            loadCurrentParticellaData();
        }
        
        function loadCurrentParticellaData() {
            const particellaIndex = localStorage.getItem('current-particella-index');
            if (particellaIndex !== null) {
                const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
                const particella = particelleData[parseInt(particellaIndex)];
                
                if (particella && particella.formData) {
                    console.log('Loading data for particella index:', particellaIndex);
                    Object.keys(particella.formData).forEach(key => {
                        const element = document.querySelector(`[name="${key}"]`);
                        if (element) {
                            // Skip chiave-db field - it should always be calculated, never loaded
                            if (key !== 'chiave-db') {
                                element.value = particella.formData[key];
                                if (key === 'superficie-particella') {
                                    console.log('Loaded superficie-particella:', particella.formData[key], 'Element value:', element.value);
                                }
                            }
                        }
                    });
                    
                    // After loading all data, recalculate chiave database
                    setTimeout(() => {
                        const pfInput = document.getElementById('particella');
                        const spfInput = document.getElementById('sottoparticella');
                        const chiaveDbInput = document.getElementById('chiave-db');
                        
                        if (pfInput && spfInput && chiaveDbInput) {
                            const pfValue = pfInput.value.trim();
                            const spfValue = spfInput.value.trim();
                            const concatenated = pfValue + spfValue;
                            chiaveDbInput.value = concatenated;
                            console.log('Recalculated chiave DB after data load:', concatenated);
                        }
                    }, 100);
                } else {
                    // Clear form for new particella
                    document.getElementById('forestry-form').reset();
                }
            }
        }

        function loadProjectData() {
            const projectData = JSON.parse(localStorage.getItem('current-project'));
            if (projectData) {
                document.getElementById('display-project-name').textContent = projectData.name;
                document.getElementById('display-project-location').textContent = projectData.location;
                document.getElementById('display-project-client').textContent = projectData.client;
                document.getElementById('display-project-authority').textContent = projectData.authority;
                loadParticellaCards();
            }
        }

        function loadParticellaCards() {
            const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
            const tableBody = document.getElementById('particella-table-body');
            const emptyMessage = document.getElementById('empty-particelle-message');
            const table = document.querySelector('.particella-table');
            
            tableBody.innerHTML = '';
            
            if (particelleData.length === 0) {
                table.style.display = 'none';
                emptyMessage.style.display = 'flex';
            } else {
                table.style.display = 'table';
                emptyMessage.style.display = 'none';
                
                particelleData.forEach((particella, index) => {
                    const row = document.createElement('tr');
                    row.className = 'particella-row';
                    
                    // Extract PF and SPF data
                    let pfValue = 'Non specificata';
                    let spfValue = 'Non specificata';
                    if (particella.formData) {
                        pfValue = particella.formData['particella'] || 'Non specificata';
                        spfValue = particella.formData['sottoparticella'] || 'Non specificata';
                    }
                    
                    // Extract species data (first species from the form data)
                    let specieName = 'Non specificata';
                    if (particella.formData && particella.formData.species) {
                        specieName = particella.formData.species;
                    }
                    
                    // Extract intervention data
                    let interventoProgr = 'Non specificato';
                    let anno = 'Non specificato';
                    if (particella.formData) {
                        // Check for intervention table data or ultimo intervento
                        interventoProgr = particella.formData['ultimo-intervento'] || 'Non specificato';
                        anno = particella.formData['ultimo-intervento-anno'] || 'Non specificato';
                    }
                    
                    // Get superficie particella from form data (calculated value) and format to 4 decimals
                    let superficieParticella = 'Non specificata';
                    if (particella.formData && particella.formData['superficie-particella']) {
                        const value = parseFloat(particella.formData['superficie-particella']);
                        superficieParticella = !isNaN(value) ? value.toFixed(4) : particella.formData['superficie-particella'];
                    } else if (particella.superficie) {
                        const value = parseFloat(particella.superficie);
                        superficieParticella = !isNaN(value) ? value.toFixed(4) : particella.superficie; // fallback to old field
                    }

                    row.innerHTML = `
                        <td class="particella-name">${pfValue}</td>
                        <td class="particella-spf">${spfValue}</td>
                        <td class="particella-superficie">${superficieParticella}</td>
                        <td class="particella-specie">${specieName}</td>
                        <td class="particella-intervento">${interventoProgr}</td>
                        <td class="particella-anno">${anno}</td>
                        <td class="particella-actions">
                            <button class="action-btn edit-btn" onclick="editParticella(${index})" title="Modifica">‚úèÔ∏è</button>
                            <button class="action-btn duplicate-btn" onclick="duplicateParticella(${index})" title="Duplica">üìã</button>
                            <button class="action-btn delete-btn" onclick="deleteParticella(${index})" title="Elimina">üóëÔ∏è</button>
                        </td>
                    `;
                    
                    // Make row clickable (except for action buttons)
                    row.addEventListener('click', function(e) {
                        if (!e.target.classList.contains('action-btn')) {
                            editParticella(index);
                        }
                    });
                    
                    tableBody.appendChild(row);
                });
            }
        }

        // Home page navigation
        document.getElementById('new-project-btn').addEventListener('click', function() {
            document.getElementById('project-modal').classList.remove('hidden');
        });

        document.getElementById('cancel-project-btn').addEventListener('click', function() {
            document.getElementById('project-modal').classList.add('hidden');
            document.getElementById('project-form').reset();
        });

        document.getElementById('start-project-btn').addEventListener('click', function() {
            const form = document.getElementById('project-form');
            if (form.checkValidity()) {
                // Save project data
                const projectData = {
                    name: document.getElementById('project-name').value,
                    location: document.getElementById('project-location').value,
                    client: document.getElementById('project-client').value,
                    authority: document.getElementById('project-authority').value,
                    createdAt: new Date().toISOString()
                };
                
                localStorage.setItem('current-project', JSON.stringify(projectData));
                localStorage.setItem('project-' + Date.now(), JSON.stringify(projectData));
                
                // Close modal and show project page
                document.getElementById('project-modal').classList.add('hidden');
                showProjectPage();
            } else {
                alert('Compilare tutti i campi richiesti.');
            }
        });

        // Placeholder functions for other buttons
        document.getElementById('load-project-btn').addEventListener('click', function() {
            alert('Funzionalit√† "Carica progetto" in sviluppo');
        });

        document.getElementById('manage-projects-btn').addEventListener('click', function() {
            alert('Funzionalit√† "Gestione progetti" in sviluppo');
        });

        document.getElementById('settings-btn').addEventListener('click', function() {
            document.getElementById('settings-modal').classList.remove('hidden');
        });

        document.getElementById('guide-btn').addEventListener('click', function() {
            alert('Funzionalit√† "Guida" in sviluppo');
        });

        // Close modal when clicking outside
        document.getElementById('project-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
                document.getElementById('project-form').reset();
            }
        });

        // Project page navigation
        document.getElementById('back-to-home-btn').addEventListener('click', function() {
            showHomePage();
        });

        document.getElementById('add-particella-btn').addEventListener('click', function() {
            createNewParticella();
        });

        // Particella management functions
        function createNewParticella() {
            const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
            const newParticella = {
                id: Date.now(),
                createdAt: new Date().toISOString(),
                localita: '',
                superficie: ''
            };
            
            // Store current particella index for editing
            localStorage.setItem('current-particella-index', particelleData.length.toString());
            particelleData.push(newParticella);
            localStorage.setItem('project-particelle', JSON.stringify(particelleData));
            
            // Navigate to form for editing the new particella
            showMainForm();
        }

        function editParticella(index) {
            localStorage.setItem('current-particella-index', index.toString());
            showMainForm();
        }

        function duplicateParticella(index) {
            const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
            const originalParticella = particelleData[index];
            
            if (originalParticella) {
                // Create a deep copy to ensure complete independence
                const duplicatedParticella = {
                    id: Date.now(),
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    localita: originalParticella.localita || '',
                    superficie: originalParticella.superficie || '',
                    // Deep copy the form data
                    formData: originalParticella.formData ? JSON.parse(JSON.stringify(originalParticella.formData)) : {}
                };
                
                particelleData.push(duplicatedParticella);
                localStorage.setItem('project-particelle', JSON.stringify(particelleData));
                loadParticellaCards();
                
                // Show confirmation
                alert('Particella duplicata con successo!');
            }
        }

        function deleteParticella(index) {
            if (confirm('Sei sicuro di voler eliminare questa particella?')) {
                const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
                particelleData.splice(index, 1);
                localStorage.setItem('project-particelle', JSON.stringify(particelleData));
                loadParticellaCards();
            }
        }

        // Add back to project button in main form
        function addBackToProjectButton() {
            const formHeader = document.querySelector('.form-header');
            if (formHeader && !document.getElementById('back-to-project-btn')) {
                const backBtn = document.createElement('button');
                backBtn.id = 'back-to-project-btn';
                backBtn.type = 'button';
                backBtn.className = 'back-btn';
                backBtn.innerHTML = '‚Üê Torna al progetto';
                backBtn.addEventListener('click', function() {
                    // Save current form data before going back
                    const formData = new FormData(document.getElementById('forestry-form'));
                    const data = Object.fromEntries(formData);
                    const particellaIndex = localStorage.getItem('current-particella-index');
                    
                    if (particellaIndex !== null) {
                        const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
                        if (particelleData[parseInt(particellaIndex)]) {
                            // Update particella data with form values
                            particelleData[parseInt(particellaIndex)] = {
                                ...particelleData[parseInt(particellaIndex)],
                                localita: data.localita || '',
                                superficie: data['superficie-particella'] || '',
                                formData: data,
                                lastModified: new Date().toISOString()
                            };
                            localStorage.setItem('project-particelle', JSON.stringify(particelleData));
                        }
                    }
                    
                    showProjectPage();
                });
                formHeader.appendChild(backBtn);
            }
        }

        // Initialize back button when form is shown
        const originalShowMainForm = showMainForm;
        showMainForm = function() {
            originalShowMainForm();
            setTimeout(() => addBackToProjectButton(), 100);
        };

        // Registrazione del Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registrato con successo: ', registration.scope);
                    }, function(err) {
                        console.log('ServiceWorker registrazione fallita: ', err);
                    });
            });
        }

        // Funzionalit√† per aggiungere infrastrutture
        document.getElementById('add-infrastruttura-btn').addEventListener('click', function() {
            const col1 = document.getElementById('infra-col-1');
            const col2 = document.getElementById('infra-col-2');
            const col3 = document.getElementById('infra-col-3');
            const col1Count = col1.children.length;
            const col2Count = col2.children.length;
            const col3Count = col3.children.length;
            const totalItems = col1Count + col2Count + col3Count;

            // Limit to 6 items maximum
            if (totalItems >= 6) {
                alert('Massimo 6 infrastrutture consentite');
                return;
            }

            let targetColumn;
            let showDeleteBtn = false;

            // Distribution logic: Items 1-2 in col1, 3-4 in col2, 5-6 in col3
            if (col1Count < 2) {
                targetColumn = col1;
                showDeleteBtn = totalItems >= 1; // Show delete for 2nd item and beyond
            } else if (col2Count < 2) {
                targetColumn = col2;
                showDeleteBtn = true;
            } else {
                targetColumn = col3;
                showDeleteBtn = true;
            }
            
            const newFieldGroup = document.createElement('div');
            newFieldGroup.className = 'field-group';
            newFieldGroup.innerHTML = `
                <div class="input-with-delete">
                    <select name="viabilita-extra">
                        <option value="">Seleziona...</option>
                        <option value="Strada camionabile principale">Strada camionabile principale</option>
                        <option value="Strada camionabile secondaria">Strada camionabile secondaria</option>
                        <option value="Strada trattorabile">Strada trattorabile</option>
                        <option value="Pista camionabile">Pista camionabile</option>
                        <option value="Pista principale per trattori">Pista principale per trattori</option>
                        <option value="Pista secondaria per trattori">Pista secondaria per trattori</option>
                        <option value="Linee di esbosco">Linee di esbosco</option>
                        <option value="Imposto permanente">Imposto permanente</option>
                        <option value="Imposto temporaneo">Imposto temporaneo</option>
                    </select>
                    ${showDeleteBtn ? '<button type="button" class="delete-row-btn" onclick="deleteInfrastructureRow(this)" title="Elimina">‚úï</button>' : ''}
                </div>
            `;
            targetColumn.appendChild(newFieldGroup);
        });

        // Funzione per eliminare righe infrastruttura
        function deleteInfrastructureRow(button) {
            const fieldGroup = button.closest('.field-group');
            fieldGroup.remove();
        }

        // Funzionalit√† per aggiungere righe specie
        document.getElementById('add-species').addEventListener('click', function() {
            const tbody = document.querySelector('.species-table tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td>
                    <select>
                        <option value="">Seleziona specie...</option>
                        <option value="Abete bianco (Abies alba)">Abete bianco <em>(Abies alba)</em></option>
                        <option value="Abete rosso (Picea abies)">Abete rosso <em>(Picea abies)</em></option>
                        <option value="Acero campestre (Acer campestre)">Acero campestre <em>(Acer campestre)</em></option>
                        <option value="Acero di monte (Acer pseudoplatanus)">Acero di monte <em>(Acer pseudoplatanus)</em></option>
                        <option value="Acero opalo (Acer opalus)">Acero opalo <em>(Acer opalus)</em></option>
                        <option value="Acero riccio (Acer lobelii)">Acero riccio <em>(Acer lobelii)</em></option>
                        <option value="Acero tribolo (Acer tataricum)">Acero tribolo <em>(Acer tataricum)</em></option>
                        <option value="Ailanto (Ailanthus altissima)">Ailanto <em>(Ailanthus altissima)</em></option>
                        <option value="Betulla (Betula pendula)">Betulla <em>(Betula pendula)</em></option>
                        <option value="Carpino bianco (Carpinus betulus)">Carpino bianco <em>(Carpinus betulus)</em></option>
                        <option value="Carpino nero (Ostrya carpinifolia)">Carpino nero <em>(Ostrya carpinifolia)</em></option>
                        <option value="Castagno (Castanea sativa)">Castagno <em>(Castanea sativa)</em></option>
                        <option value="Cedro dell'Atlante (Cedrus atlantica)">Cedro dell'Atlante <em>(Cedrus atlantica)</em></option>
                        <option value="Cedro deodara (Cedrus deodara)">Cedro deodara <em>(Cedrus deodara)</em></option>
                        <option value="Cedro del Libano (Cedrus libani)">Cedro del Libano <em>(Cedrus libani)</em></option>
                        <option value="Cerro (Quercus cerris)">Cerro <em>(Quercus cerris)</em></option>
                        <option value="Chamaecyparis (Chamaecyparis sp)">Chamaecyparis <em>(Chamaecyparis sp)</em></option>
                        <option value="Ciavardello (Quercus robur)">Ciavardello <em>(Quercus robur)</em></option>
                        <option value="Ciliegio (Prunus avium)">Ciliegio <em>(Prunus avium)</em></option>
                        <option value="Cipresso comune (Cupressus sempervirens)">Cipresso comune <em>(Cupressus sempervirens)</em></option>
                        <option value="Cipresso dell'Arizona (Cupressus arizonica)">Cipresso dell'Arizona <em>(Cupressus arizonica)</em></option>
                        <option value="Cipresso di Monterey (Cupressus macrocarpa)">Cipresso di Monterey <em>(Cupressus macrocarpa)</em></option>
                        <option value="Corbezzolo (Arbutus unedo)">Corbezzolo <em>(Arbutus unedo)</em></option>
                        <option value="Douglasia (Pseudotsuga menziesii)">Douglasia <em>(Pseudotsuga menziesii)</em></option>
                        <option value="Faggio (Fagus sylvatica)">Faggio <em>(Fagus sylvatica)</em></option>
                        <option value="Farnetto (Fraxinus ornus)">Farnetto <em>(Fraxinus ornus)</em></option>
                        <option value="Farnia (Fraxinus excelsior)">Farnia <em>(Fraxinus excelsior)</em></option>
                        <option value="Frassino maggiore (Fraxinus angustifolia)">Frassino maggiore <em>(Fraxinus angustifolia)</em></option>
                        <option value="Frassino ossifillo (Fraxinus oxycarpa)">Frassino ossifillo <em>(Fraxinus oxycarpa)</em></option>
                        <option value="Ippocastano (Aesculus hippocastanum)">Ippocastano <em>(Aesculus hippocastanum)</em></option>
                        <option value="Leccio (Quercus ilex)">Leccio <em>(Quercus ilex)</em></option>
                        <option value="Nocciolo (Corylus avellana)">Nocciolo <em>(Corylus avellana)</em></option>
                        <option value="Noce (Juglans regia)">Noce <em>(Juglans regia)</em></option>
                        <option value="Ontano bianco (Alnus incana)">Ontano bianco <em>(Alnus incana)</em></option>
                        <option value="Ontano napoletano (Alnus cordata)">Ontano napoletano <em>(Alnus cordata)</em></option>
                        <option value="Ontano nero (Alnus glutinosa)">Ontano nero <em>(Alnus glutinosa)</em></option>
                        <option value="Orniello (Fraxinus ornus)">Orniello <em>(Fraxinus ornus)</em></option>
                        <option value="Pino d'Aleppo (Pinus halepensis)">Pino d'Aleppo <em>(Pinus halepensis)</em></option>
                        <option value="Pino domestico (Pinus pinea)">Pino domestico <em>(Pinus pinea)</em></option>
                        <option value="Pino insigne (Pinus radiata)">Pino insigne <em>(Pinus radiata)</em></option>
                        <option value="Pino loricato (Pinus heldreichii)">Pino loricato <em>(Pinus heldreichii)</em></option>
                        <option value="Pino marittimo (Pinus pinaster)">Pino marittimo <em>(Pinus pinaster)</em></option>
                        <option value="Pino nero (Pinus nigra)">Pino nero <em>(Pinus nigra)</em></option>
                        <option value="Pino silvestre (Pinus sylvestris)">Pino silvestre <em>(Pinus sylvestris)</em></option>
                        <option value="Pioppo bianco (Populus alba)">Pioppo bianco <em>(Populus alba)</em></option>
                        <option value="Pioppo cinerino (Populus cinerea)">Pioppo cinerino <em>(Populus cinerea)</em></option>
                        <option value="Pioppo nero (Populus nigra)">Pioppo nero <em>(Populus nigra)</em></option>
                        <option value="Pioppo tremulo (Populus tremula)">Pioppo tremulo <em>(Populus tremula)</em></option>
                        <option value="Robinia (Robinia pseudoacacia)">Robinia <em>(Robinia pseudoacacia)</em></option>
                        <option value="Rovere (Quercus robur)">Rovere <em>(Quercus robur)</em></option>
                        <option value="Roverella (Quercus petraea)">Roverella <em>(Quercus petraea)</em></option>
                        <option value="Salice (Salix spp)">Salice <em>(Salix spp)</em></option>
                        <option value="Sorbo degli uccellatori (Sorbus aucuparia)">Sorbo degli uccellatori <em>(Sorbus aucuparia)</em></option>
                        <option value="Sorbo domestico (Sorbus domestica)">Sorbo domestico <em>(Sorbus domestica)</em></option>
                        <option value="Sughera (Quercus suber)">Sughera <em>(Quercus suber)</em></option>
                        <option value="Tasso (Taxus baccata)">Tasso <em>(Taxus baccata)</em></option>
                        <option value="Thuja (Thuja occidentalis)">Thuja <em>(Thuja occidentalis)</em></option>
                        <option value="Tiglio (Tilia cordata)">Tiglio <em>(Tilia cordata)</em></option>
                    </select>
                </td>
                <td><input type="number" step="1" max="99" class="no-spinner"></td>
                <td><input type="number" step="1" max="999" class="no-spinner diameter-field"></td>
                <td><input type="number" step="1" max="999" class="no-spinner height-field"></td>
                <td><input type="number" step="0.01" max="9999.99" readonly class="calculated-field volume-field"></td>
                <td><input type="number" step="0.01" readonly class="calculated-field volume-per-hectare-field"></td>
                <td><button type="button" class="delete-row-btn" onclick="deleteSpeciesRow(this)">üóëÔ∏è</button></td>
            `;
        });

        // Funzionalit√† per aggiungere righe intervento
        document.getElementById('add-intervention').addEventListener('click', function() {
            const tbody = document.querySelector('.intervention-table tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td>
                    <select>
                        <option value="">Seleziona intervento...</option>
                        <option value="Conversione a ceduo">Conversione a ceduo</option>
                        <option value="Diradamento dal basso">Diradamento dal basso</option>
                        <option value="Diradamento del ceduo">Diradamento del ceduo</option>
                        <option value="Diradamento geometrico">Diradamento geometrico</option>
                        <option value="Diradamento selettivo">Diradamento selettivo</option>
                        <option value="Manutenzione attorno manufatto">Manutenzione attorno manufatto</option>
                        <option value="Manutenzione idraulica">Manutenzione idraulica</option>
                        <option value="Manutenzione lungo viabilit√†">Manutenzione lungo viabilit√†</option>
                        <option value="Recupero dell'uso agricolo storico del suolo">Recupero dell'uso agricolo storico del suolo</option>
                        <option value="Sfollo e spalcatura">Sfollo e spalcatura</option>
                        <option value="Sostituzione di specie">Sostituzione di specie</option>
                        <option value="Taglio a scelta">Taglio a scelta</option>
                        <option value="Taglio della fustaia su ceduo">Taglio della fustaia su ceduo</option>
                        <option value="Taglio del ceduo a sterzo">Taglio del ceduo a sterzo</option>
                        <option value="Taglio del ceduo composto">Taglio del ceduo composto</option>
                        <option value="Taglio del ceduo coniferato">Taglio del ceduo coniferato</option>
                        <option value="Taglio del ceduo intensamente matricinato">Taglio del ceduo intensamente matricinato</option>
                        <option value="Taglio del ceduo semplice con rilascio di matricine">Taglio del ceduo semplice con rilascio di matricine</option>
                        <option value="Taglio di avviamento all'alto fusto">Taglio di avviamento all'alto fusto</option>
                        <option value="Taglio raso della fustaia con rimboschimento artificiale">Taglio raso della fustaia con rimboschimento artificiale</option>
                        <option value="Taglio saltuario">Taglio saltuario</option>
                        <option value="Trasformazione da terreno saldo a periodica lavorazione">Trasformazione da terreno saldo a periodica lavorazione</option>
                        <option value="Altro: dettagliato in descrizione">Altro: dettagliato in descrizione</option>
                    </select>
                </td>
                <td><input type="number" step="0.0001" max="999.9999" class="intervention-superficie-field"></td>
                <td><input type="number" min="1900" max="2050" class="intervention-anno-field"></td>
                <td><input type="number" readonly class="calculated-field intervention-eta-field"></td>
                <td><input type="number" step="0.01" max="9999.99" readonly class="calculated-field intervention-provv-field"></td>
                <td><input type="number" step="0.01" max="9999.99" readonly class="calculated-field intervention-ripresa-field"></td>
                <td><button type="button" class="delete-row-btn" onclick="deleteInterventionRow(this)">üóëÔ∏è</button></td>
            `;
            
            // Add calculation listeners to the new row
            addInterventionCalculationListeners(newRow);
            
            // Add formatting listeners to the new intervention superficie field (EXACTLY like superficie-sottoparticella)
            const newInterventionSuperficieField = newRow.querySelector('.intervention-superficie-field');
            if (newInterventionSuperficieField) {
                // Add input listener for real-time validation (like superficie-sottoparticella)
                newInterventionSuperficieField.addEventListener('input', function(e) {
                    const value = e.target.value;
                    // Allow only numbers, dots, and commas
                    const sanitized = value.replace(/[^0-9.,]/g, '');
                    if (sanitized !== value) {
                        e.target.value = sanitized;
                    }
                });
                
                // Add blur listener for final formatting (like superficie-sottoparticella)
                newInterventionSuperficieField.addEventListener('blur', function() {
                    validateAndFormatDecimals(this);
                });
            }
            
            // Calculate et√†, provv and ripresa for the new row
            calculateInterventionEta();
            calculateInterventionProvv();
            calculateInterventionRipresa();
        });

        // Funzione per eliminare righe specie
        function deleteSpeciesRow(button) {
            const row = button.closest('tr');
            row.remove();
            // Validate percentages after deletion
            validateTotalPercentage();
            // Recalculate total volume after deletion
            calculateTotalVolume();
        }

        // Funzione per eliminare righe intervento
        function deleteInterventionRow(button) {
            const row = button.closest('tr');
            row.remove();
        }

        // Funzionalit√† per aggiungere particelle catastali
        document.getElementById('add-cadastral').addEventListener('click', function() {
            const leftTbody = document.getElementById('cadastral-left-tbody');
            const rightTbody = document.getElementById('cadastral-right-tbody');
            const leftRowCount = leftTbody.children.length;
            const rightRowCount = rightTbody.children.length;
            const totalRows = leftRowCount + rightRowCount;

            let targetTbody;
            let showDeleteBtn = false;

            // Logic for row distribution:
            // Rows 1-4: Left column
            // Rows 5-8: Right column
            // Row 9: Move 5th from right to left (left=5, right=4), add 9th to right (left=5, right=5)
            // Row 10: Add to right (left=5, right=6)
            // Row 11: Move 6th from right to left (left=6, right=5), add 11th to right (left=6, right=6)
            // Pattern: When adding odd-numbered rows ‚â•9, move one from right to left first

            if (totalRows >= 8 && (totalRows + 1) % 2 === 1) {
                // For 9th, 11th, 13th... rows: move one row from right to left first
                if (rightRowCount > 4) {
                    const rowToMove = rightTbody.children[0]; // Move the first row from right
                    leftTbody.appendChild(rowToMove);
                }
            }

            // Determine where to add the new row
            const updatedLeftCount = leftTbody.children.length;
            const updatedRightCount = rightTbody.children.length;

            if (updatedLeftCount < 4) {
                targetTbody = leftTbody;
                showDeleteBtn = totalRows >= 1; // Show delete button for 2nd row and beyond
            } else {
                targetTbody = rightTbody;
                showDeleteBtn = true;
            }

            const newRow = targetTbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="number" step="0.01" class="cadastral-superficie-field"></td>
                ${showDeleteBtn ? '<td><button type="button" class="delete-row-btn" onclick="deleteCadastralRow(this)">üóëÔ∏è</button></td>' : '<td></td>'}
            `;
            
            // Add validation and formatting listeners to the new superficie field (EXACTLY like superficie-sottoparticella)
            const newSuperficieField = newRow.querySelector('.cadastral-superficie-field');
            if (newSuperficieField) {
                // Add validation listener for cadastral sum checking
                newSuperficieField.addEventListener('input', validateCadastralSuperficie);
                
                // Add input listener for real-time validation (like superficie-sottoparticella)
                newSuperficieField.addEventListener('input', function(e) {
                    const value = e.target.value;
                    // Allow only numbers, dots, and commas
                    const sanitized = value.replace(/[^0-9.,]/g, '');
                    if (sanitized !== value) {
                        e.target.value = sanitized;
                    }
                });
                
                // Add blur listener for final formatting (like superficie-sottoparticella)
                newSuperficieField.addEventListener('blur', function() {
                    validateAndFormatDecimals(this);
                });
            }
        });

        // Funzione per eliminare righe catastali
        function deleteCadastralRow(button) {
            const row = button.closest('tr');
            row.remove();
            
            // Validate after deletion
            validateCadastralSuperficie();
        }

        // Salvataggio dati nel localStorage
        document.getElementById('save-btn').addEventListener('click', function() {
            const formData = new FormData(document.getElementById('forestry-form'));
            const data = Object.fromEntries(formData);
            localStorage.setItem('forestry-survey-' + Date.now(), JSON.stringify(data));
            alert('Dati salvati con successo!');
        });

        // Validazione e formatazione decimali per superficie
        function validateAndFormatDecimals(inputElement) {
            const value = inputElement.value;
            if (value && value.trim() !== '') {
                // Replace comma with dot for European decimal format
                const normalizedValue = value.replace(',', '.');
                const numValue = parseFloat(normalizedValue);
                if (!isNaN(numValue) && numValue >= 0 && numValue <= 999.9999) {
                    // Always format to 4 decimal places
                    inputElement.value = numValue.toFixed(4);
                } else {
                    alert('Inserire un valore numerico valido tra 0 e 999.9999');
                    inputElement.focus();
                }
            }
        }

        // Add input validation for superficie sottoparticella (real-time)
        document.getElementById('superficie-sottoparticella').addEventListener('input', function(e) {
            const value = e.target.value;
            // Allow only numbers, dots, and commas
            const sanitized = value.replace(/[^0-9.,]/g, '');
            if (sanitized !== value) {
                e.target.value = sanitized;
            }
        });

        document.getElementById('superficie-particella').addEventListener('blur', function() {
            validateAndFormatDecimals(this);
        });

        document.getElementById('superficie-sottoparticella').addEventListener('blur', function() {
            validateAndFormatDecimals(this);
        });

        // Auto-save ogni 30 secondi - save to specific particella
        setInterval(function() {
            const particellaIndex = localStorage.getItem('current-particella-index');
            if (particellaIndex !== null) {
                const formData = new FormData(document.getElementById('forestry-form'));
                const data = Object.fromEntries(formData);
                
                const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
                if (particelleData[parseInt(particellaIndex)]) {
                    particelleData[parseInt(particellaIndex)] = {
                        ...particelleData[parseInt(particellaIndex)],
                        formData: data,
                        lastModified: new Date().toISOString()
                    };
                    localStorage.setItem('project-particelle', JSON.stringify(particelleData));
                    console.log('Auto-saved data for particella index:', particellaIndex);
                }
            }
        }, 30000);

        // Remove global auto-load since we now load per-particella data
        // Data loading is handled by loadCurrentParticellaData() when showMainForm() is called

        // ========================================
        // SETTINGS MODAL FUNCTIONALITY
        // ========================================
        
        // Settings modal event listeners
        document.getElementById('cancel-settings-btn').addEventListener('click', function() {
            document.getElementById('settings-modal').classList.add('hidden');
        });
        
        document.getElementById('save-settings-btn').addEventListener('click', function() {
            // Save header and footer content to localStorage
            const headerContent = document.getElementById('header-editor').innerHTML;
            const footerContent = document.getElementById('footer-editor').innerHTML;
            
            localStorage.setItem('print-header-content', headerContent);
            localStorage.setItem('print-footer-content', footerContent);
            
            // Apply to current page
            applyHeaderFooter();
            
            // Close modal
            document.getElementById('settings-modal').classList.add('hidden');
            
            alert('Impostazioni Header/Footer salvate!');
        });
        
        // Settings tabs functionality
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active from all tabs and contents
                document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.settings-content').forEach(c => c.classList.remove('active'));
                
                // Add active to clicked tab
                this.classList.add('active');
                
                // Show corresponding content
                const targetTab = this.dataset.tab;
                document.getElementById(targetTab + '-settings').classList.add('active');
            });
        });
        
        // Rich text editor formatting functions
        function formatText(command, value = null) {
            document.execCommand(command, false, value);
        }
        
        // Load saved header/footer content on page load
        function loadHeaderFooterSettings() {
            const savedHeader = localStorage.getItem('print-header-content');
            const savedFooter = localStorage.getItem('print-footer-content');
            
            if (savedHeader) {
                document.getElementById('header-editor').innerHTML = savedHeader;
            }
            
            if (savedFooter) {
                document.getElementById('footer-editor').innerHTML = savedFooter;
            }
            
            // Apply to current page
            applyHeaderFooter();
        }
        
        // Apply header and footer to the form page
        function applyHeaderFooter() {
            const headerContent = localStorage.getItem('print-header-content');
            const footerContent = localStorage.getItem('print-footer-content');
            
            const headerElement = document.querySelector('.print-header-content');
            const footerElement = document.querySelector('.print-footer-content');
            
            if (headerContent && headerElement) {
                headerElement.innerHTML = headerContent;
            }
            
            if (footerContent && footerElement) {
                footerElement.innerHTML = footerContent;
            }
        }
        
        // Close settings modal when clicking outside
        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });
        
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadHeaderFooterSettings();
            setupAutomaticCalculations();
        });

        // Automatic calculation for chiave database (PF + SPF) and superficie
        function setupAutomaticCalculations() {
            const pfInput = document.getElementById('particella');
            const spfInput = document.getElementById('sottoparticella');
            const chiaveDbInput = document.getElementById('chiave-db');
            const superficieSottoparticellaInput = document.getElementById('superficie-sottoparticella');
            const superficieParticellaInput = document.getElementById('superficie-particella');

            console.log('PF Input:', pfInput);
            console.log('SPF Input:', spfInput);
            console.log('Chiave DB Input:', chiaveDbInput);
            console.log('Superficie Sottoparticella Input:', superficieSottoparticellaInput);
            console.log('Superficie Particella Input:', superficieParticellaInput);

            const calculateChiaveDb = () => {
                const pfValue = pfInput.value.trim();
                const spfValue = spfInput.value.trim();
                const concatenated = pfValue + spfValue;
                console.log('Calculating chiave db:', pfValue, '+', spfValue, '=', concatenated);
                if (chiaveDbInput) {
                    chiaveDbInput.value = concatenated;
                    console.log('Chiave DB updated to:', concatenated);
                } else {
                    console.error('Chiave DB input element not found!');
                }
            };

            const calculateSuperficieParticella = () => {
                const currentPF = pfInput.value.trim();
                if (!currentPF) {
                    superficieParticellaInput.value = '';
                    return;
                }

                // Calculate total for this PF and update current form
                const totalSuperficie = calculateTotalSuperficieForPF(currentPF);
                const formattedValue = totalSuperficie > 0 ? totalSuperficie.toFixed(4) : '';
                superficieParticellaInput.value = formattedValue;
                console.log('Setting superficie particella for PF', currentPF, ':', formattedValue, 'Input value:', superficieParticellaInput.value);
            };

            const calculateTotalSuperficieForPF = (targetPF) => {
                const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
                let totalSuperficie = 0;
                
                console.log('=== DEBUG: Calculating total for PF:', targetPF, '===');
                
                // Get current form's PF+SPF combination to exclude it from saved data
                const currentPF = pfInput.value.trim();
                const currentSPF = spfInput.value.trim();
                const currentParticellaIndex = localStorage.getItem('current-particella-index');
                const currentIndex = currentParticellaIndex ? parseInt(currentParticellaIndex) : -1;
                
                console.log(`Current editing: PF=${currentPF}, SPF=${currentSPF}, Index=${currentIndex}`);
                
                // Sum all superficie sottoparticella values for the same PF (excluding current)
                particelleData.forEach((particella, index) => {
                    if (particella.formData) {
                        const particellaPF = particella.formData['particella'];
                        const particellaSPF = particella.formData['sottoparticella'];
                        const superficieSottoRaw = particella.formData['superficie-sottoparticella'];
                        const superficieSotto = parseFloat(superficieSottoRaw) || 0;
                        
                        console.log(`Particella ${index}: PF=${particellaPF}, SPF=${particellaSPF}, Superficie=${superficieSottoRaw} -> ${superficieSotto}`);
                        
                        // Skip if this is the current particella being edited
                        if (index === currentIndex) {
                            console.log(`  -> SKIPPED (current particella being edited)`);
                            return;
                        }
                        
                        if (particellaPF === targetPF && superficieSotto > 0) {
                            totalSuperficie += superficieSotto;
                            console.log(`  -> Added ${superficieSotto}, running total: ${totalSuperficie}`);
                        }
                    }
                });

                // Add current form's superficie sottoparticella if it matches the target PF
                const currentSuperficieSottoRaw = superficieSottoparticellaInput.value;
                const currentSuperficieSotto = parseFloat(currentSuperficieSottoRaw) || 0;
                
                console.log(`Current form: PF=${currentPF}, SPF=${currentSPF}, Superficie=${currentSuperficieSottoRaw} -> ${currentSuperficieSotto}`);
                
                if (currentPF === targetPF && currentSuperficieSotto > 0) {
                    totalSuperficie += currentSuperficieSotto;
                    console.log(`  -> Added current form ${currentSuperficieSotto}, final total: ${totalSuperficie}`);
                }

                console.log('=== FINAL TOTAL:', totalSuperficie, '===');
                return totalSuperficie;
            };

            const updateAllParticelleSuperficie = () => {
                // Get current data to determine which PFs need updating
                const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
                const pfToUpdate = new Set();
                
                // Find all unique PF values that need updating
                particelleData.forEach(particella => {
                    if (particella.formData && particella.formData['particella']) {
                        pfToUpdate.add(particella.formData['particella']);
                    }
                });
                
                // Also add current form's PF
                const currentPF = pfInput.value.trim();
                if (currentPF) {
                    pfToUpdate.add(currentPF);
                }

                // Update all particelle data with new superficie particella values
                let dataChanged = false;
                particelleData.forEach(particella => {
                    if (particella.formData && particella.formData['particella']) {
                        const particellaPF = particella.formData['particella'];
                        if (pfToUpdate.has(particellaPF)) {
                            const newTotal = calculateTotalSuperficieForPF(particellaPF);
                            const newValue = newTotal > 0 ? newTotal.toFixed(4) : '';
                            
                            if (particella.formData['superficie-particella'] !== newValue) {
                                particella.formData['superficie-particella'] = newValue;
                                dataChanged = true;
                            }
                        }
                    }
                });

                // Save updated data if changes were made
                if (dataChanged) {
                    localStorage.setItem('project-particelle', JSON.stringify(particelleData));
                    console.log('Updated all particelle superficie values');
                    
                    // Refresh the particelle table (it will update in background even if not visible)
                    if (typeof loadParticellaCards === 'function') {
                        loadParticellaCards();
                        console.log('Refreshed particelle table in background');
                    }
                }
            };

            const loadSuperficieSottoparticella = () => {
                const currentPF = pfInput.value.trim();
                const currentSPF = spfInput.value.trim();
                
                if (!currentPF || !currentSPF) {
                    return;
                }

                // Look for existing data for this PF+SPF combination
                const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
                
                for (let particella of particelleData) {
                    if (particella.formData) {
                        const particellaPF = particella.formData['particella'];
                        const particellaSPF = particella.formData['sottoparticella'];
                        
                        if (particellaPF === currentPF && particellaSPF === currentSPF) {
                            const savedSuperficie = particella.formData['superficie-sottoparticella'];
                            if (savedSuperficie && !superficieSottoparticellaInput.value) {
                                superficieSottoparticellaInput.value = savedSuperficie;
                                console.log('Loaded existing superficie sottoparticella:', savedSuperficie);
                                break;
                            }
                        }
                    }
                }
            };

            const handlePFSPFChange = () => {
                calculateChiaveDb();
                loadSuperficieSottoparticella();
                calculateSuperficieParticella();
            };

            const handleSuperficieChange = () => {
                calculateSuperficieParticella();
                
                // Save current form data before updating all particelle
                const particellaIndex = localStorage.getItem('current-particella-index');
                if (particellaIndex !== null) {
                    const formData = new FormData(document.getElementById('forestry-form'));
                    const data = Object.fromEntries(formData);
                    
                    const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
                    if (particelleData[parseInt(particellaIndex)]) {
                        particelleData[parseInt(particellaIndex)] = {
                            ...particelleData[parseInt(particellaIndex)],
                            formData: data,
                            lastModified: new Date().toISOString()
                        };
                        localStorage.setItem('project-particelle', JSON.stringify(particelleData));
                        console.log('Saved current form data before superficie update');
                    }
                }
                
                updateAllParticelleSuperficie();
            };

            if (pfInput && spfInput && chiaveDbInput && superficieSottoparticellaInput && superficieParticellaInput) {
                pfInput.addEventListener('input', handlePFSPFChange);
                spfInput.addEventListener('input', handlePFSPFChange);
                superficieSottoparticellaInput.addEventListener('input', handleSuperficieChange);
                
                handlePFSPFChange();
                console.log('Event listeners added successfully');
            } else {
                console.error('Could not find required input elements');
            }
        }

        // Percentage validation function
        function validateTotalPercentage() {
            const speciesTable = document.querySelector('.species-table tbody');
            const rows = speciesTable.querySelectorAll('tr');
            let totalPercentage = 0;
            const percentageFields = [];
            
            // Calculate total percentage across all species
            rows.forEach(row => {
                const percentageField = row.querySelector('td:nth-child(2) input');
                if (percentageField) {
                    const percentage = parseFloat(percentageField.value) || 0;
                    totalPercentage += percentage;
                    percentageFields.push(percentageField);
                }
            });
            
            // Remove previous error classes
            percentageFields.forEach(field => {
                field.classList.remove('percentage-error', 'percentage-warning');
            });
            
            // Check if total exceeds 100%
            if (totalPercentage > 100) {
                // Add error class to all percentage fields
                percentageFields.forEach(field => {
                    field.classList.add('percentage-error');
                });
                
                alert(`Errore: La percentuale totale delle specie √® ${totalPercentage}%, che supera il 100%. Per favore, regola le percentuali delle specie.`);
                return false;
            } else if (totalPercentage > 90 && totalPercentage <= 100) {
                // Add warning class when close to 100%
                percentageFields.forEach(field => {
                    field.classList.add('percentage-warning');
                });
            }
            
            return true;
        }

        // Function to calculate and update total volume
        function calculateTotalVolume() {
            const speciesTable = document.querySelector('.species-table tbody');
            const rows = speciesTable.querySelectorAll('tr');
            let totalVolume = 0;
            
            // Sum all individual species volumes
            rows.forEach(row => {
                const volumeField = row.querySelector('.volume-field');
                if (volumeField && volumeField.value) {
                    const volume = parseFloat(volumeField.value) || 0;
                    totalVolume += volume;
                }
            });
            
            // Update the Volume totale field
            const volumeTotaleField = document.getElementById('volume-totale');
            if (volumeTotaleField) {
                volumeTotaleField.value = totalVolume > 0 ? totalVolume.toFixed(2) : '';
            }
        }

        // Volume calculation function
        function calculateVolume(diameterField, heightField, volumeField) {
            const diameter = parseFloat(diameterField.value) || 0; // d in cm
            const height = parseFloat(heightField.value) || 0; // h in m
            
            // Get the percentage from the same row (second column)
            const row = diameterField.closest('tr');
            const percentageField = row.querySelector('td:nth-child(2) input');
            const percentage = parseFloat(percentageField.value) || 0; // % as integer (e.g., 50 for 50%)
            
            // Get volume per hectare field from the same row (sixth column)
            const volumePerHectareField = row.querySelector('.volume-per-hectare-field');
            
            // Get piante ad ettaro from the form
            const piantePinInput = document.getElementById('piante-ettaro');
            const pianteEttaro = parseFloat(piantePinInput.value) || 0;
            
            // Get superficie sottoparticella from the form
            const superficieInput = document.getElementById('superficie-sottoparticella');
            const superficieSotto = parseFloat(superficieInput.value) || 0;
            
            if (diameter > 0 && height > 0 && percentage > 0 && pianteEttaro > 0) {
                // Base volume formula: ((œÄ/4) √ó d¬≤) √ó h √ó 0.5
                // d needs to be converted from cm to m: d/100
                const diameterInMeters = diameter / 100;
                const baseVolume = ((Math.PI / 4) * Math.pow(diameterInMeters, 2)) * height * 0.5;
                
                // Volume per hectare formula: baseVolume √ó (pianteEttaro √ó (percentage/100))
                const volumePerHectare = baseVolume * (pianteEttaro * (percentage / 100));
                
                // Set volume per hectare
                if (volumePerHectareField) {
                    volumePerHectareField.value = volumePerHectare.toFixed(2);
                }
                
                // Total volume formula: volumePerHectare √ó superficieSotto
                if (superficieSotto > 0) {
                    const totalVolume = volumePerHectare * superficieSotto;
                    volumeField.value = totalVolume.toFixed(2);
                } else {
                    volumeField.value = '';
                }
            } else {
                volumeField.value = '';
                if (volumePerHectareField) {
                    volumePerHectareField.value = '';
                }
            }
            
            // Update total volume after individual volume calculation
            calculateTotalVolume();
            
            // Update all indices after changes
            calculateImd();
            calculateImh();
            calculateImv();
            
            // Update intervention calculations after volume changes
            calculateInterventionEta();
            calculateInterventionProvv();
            calculateInterventionRipresa();
        }

        // Imd calculation function
        function calculateImd() {
            const speciesTable = document.querySelector('.species-table tbody');
            const etaField = document.getElementById('eta-soprassuolo');
            const imdField = document.getElementById('imd');
            
            if (!speciesTable || !etaField || !imdField) return;
            
            const eta = parseFloat(etaField.value) || 0;
            
            if (eta <= 0) {
                imdField.value = '';
                return;
            }
            
            // Find the maximum diameter from all species rows
            const diameterFields = speciesTable.querySelectorAll('.diameter-field');
            let maxDiameter = 0;
            
            diameterFields.forEach(field => {
                const diameter = parseFloat(field.value) || 0;
                if (diameter > maxDiameter) {
                    maxDiameter = diameter;
                }
            });
            
            if (maxDiameter > 0) {
                // Imd = max diameter (in cm) / et√† (in years)
                const imd = maxDiameter / eta;
                imdField.value = imd.toFixed(2);
            } else {
                imdField.value = '';
            }
        }

        // Imh calculation function
        function calculateImh() {
            const speciesTable = document.querySelector('.species-table tbody');
            const etaField = document.getElementById('eta-soprassuolo');
            const imhField = document.getElementById('imh');
            
            if (!speciesTable || !etaField || !imhField) return;
            
            const eta = parseFloat(etaField.value) || 0;
            
            if (eta <= 0) {
                imhField.value = '';
                return;
            }
            
            // Find the maximum height from all species rows
            const heightFields = speciesTable.querySelectorAll('.height-field');
            let maxHeight = 0;
            
            heightFields.forEach(field => {
                const height = parseFloat(field.value) || 0;
                if (height > maxHeight) {
                    maxHeight = height;
                }
            });
            
            if (maxHeight > 0) {
                // Imh = max height (in m) / et√† (in years)
                const imh = maxHeight / eta;
                imhField.value = imh.toFixed(2);
            } else {
                imhField.value = '';
            }
        }

        // Imv calculation function
        function calculateImv() {
            const etaField = document.getElementById('eta-soprassuolo');
            const imvField = document.getElementById('imv');
            const volumeTotaleField = document.getElementById('volume-totale');
            
            if (!etaField || !imvField || !volumeTotaleField) return;
            
            const eta = parseFloat(etaField.value) || 0;
            const totalVolume = parseFloat(volumeTotaleField.value) || 0;
            
            if (eta <= 0) {
                imvField.value = '';
                return;
            }
            
            if (totalVolume > 0) {
                // Imv = total volume (mc) / et√† (in years)
                const imv = totalVolume / eta;
                imvField.value = imv.toFixed(2);
            } else {
                imvField.value = '';
            }
        }

        // Intervention et√† calculation function
        function calculateInterventionEta() {
            const annoRilievoField = document.getElementById('anno-rilievo');
            const etaSoprassuoloField = document.getElementById('eta-soprassuolo');
            const interventionTable = document.querySelector('.intervention-table tbody');
            
            if (!annoRilievoField || !etaSoprassuoloField || !interventionTable) return;
            
            const annoRilievo = parseFloat(annoRilievoField.value) || 0;
            const etaSoprassuolo = parseFloat(etaSoprassuoloField.value) || 0;
            
            // Calculate for all intervention rows
            const interventionRows = interventionTable.querySelectorAll('tr');
            interventionRows.forEach(row => {
                const annoInterventoField = row.querySelector('.intervention-anno-field');
                const etaInterventoField = row.querySelector('.intervention-eta-field');
                
                if (annoInterventoField && etaInterventoField) {
                    const annoIntervento = parseFloat(annoInterventoField.value) || 0;
                    
                    if (annoIntervento > 0 && annoRilievo > 0 && etaSoprassuolo >= 0) {
                        // Formula: (anno intervento - anno rilievo) + et√† soprassuolo
                        const etaIntervento = (annoIntervento - annoRilievo) + etaSoprassuolo;
                        etaInterventoField.value = etaIntervento >= 0 ? etaIntervento : '';
                    } else {
                        etaInterventoField.value = '';
                    }
                }
            });
        }

        // Intervention Provv calculation function
        function calculateInterventionProvv() {
            const superficieSottoField = document.getElementById('superficie-sottoparticella');
            const etaSoprassuoloField = document.getElementById('eta-soprassuolo');
            const imvField = document.getElementById('imv');
            const volumeTotaleField = document.getElementById('volume-totale');
            const intensitaInterventoField = document.getElementById('intensita-intervento');
            const interventionTable = document.querySelector('.intervention-table tbody');
            
            if (!superficieSottoField || !etaSoprassuoloField || !imvField || !volumeTotaleField || !intensitaInterventoField || !interventionTable) return;
            
            const superficieSotto = parseFloat(superficieSottoField.value) || 0;
            const etaSoprassuolo = parseFloat(etaSoprassuoloField.value) || 0;
            const imv = parseFloat(imvField.value) || 0;
            const volumeTotale = parseFloat(volumeTotaleField.value) || 0;
            const intensitaIntervento = parseFloat(intensitaInterventoField.value) || 0;
            
            // Calculate for all intervention rows
            const interventionRows = interventionTable.querySelectorAll('tr');
            interventionRows.forEach(row => {
                const etaInterventoField = row.querySelector('.intervention-eta-field');
                const provvField = row.querySelector('.intervention-provv-field');
                
                if (etaInterventoField && provvField) {
                    const etaIntervento = parseFloat(etaInterventoField.value) || 0;
                    
                    if (superficieSotto > 0 && imv > 0 && etaIntervento >= 0 && etaSoprassuolo >= 0) {
                        // Formula: ((Superficie sottoparticella * (Imv * (et√† intervento - et√† soprassuolo))) + Volume totale) * (intensit√† intervento / 100)
                        const etaDifference = etaIntervento - etaSoprassuolo;
                        const totalBeforeReduction = (superficieSotto * (imv * etaDifference)) + volumeTotale;
                        
                        // Apply intensit√† intervento as percentage to keep
                        const keepFactor = intensitaIntervento > 0 ? (intensitaIntervento / 100) : 1;
                        const provv = totalBeforeReduction * keepFactor;
                        
                        provvField.value = provv >= 0 ? provv.toFixed(2) : '';
                    } else {
                        provvField.value = '';
                    }
                }
            });
        }

        // Intervention Ripresa calculation function
        function calculateInterventionRipresa() {
            const imvField = document.getElementById('imv');
            const interventionTable = document.querySelector('.intervention-table tbody');
            
            if (!imvField || !interventionTable) return;
            
            const imv = parseFloat(imvField.value) || 0;
            
            // Calculate for all intervention rows
            const interventionRows = interventionTable.querySelectorAll('tr');
            interventionRows.forEach(row => {
                const superficieInterventoField = row.querySelector('.intervention-superficie-field');
                const ripreseField = row.querySelector('.intervention-ripresa-field');
                
                if (superficieInterventoField && ripreseField) {
                    const superficieIntervento = parseFloat(superficieInterventoField.value) || 0;
                    
                    if (superficieIntervento > 0 && imv > 0) {
                        // Formula: superficie intervento * Imv
                        const ripresa = superficieIntervento * imv;
                        ripreseField.value = ripresa.toFixed(2);
                    } else {
                        ripreseField.value = '';
                    }
                }
            });
        }

        // Cadastral superficie validation function
        function validateCadastralSuperficie() {
            const superficieSottoField = document.getElementById('superficie-sottoparticella');
            const cadastralSuperficieFields = document.querySelectorAll('.cadastral-superficie-field');
            const cadastralContainer = document.querySelector('.cadastral-container');
            
            if (!superficieSottoField || !cadastralContainer) return;
            
            const maxSuperficie = parseFloat(superficieSottoField.value) || 0;
            let totalCadastralSuperficie = 0;
            
            // Calculate total cadastral superficie
            cadastralSuperficieFields.forEach(field => {
                const value = parseFloat(field.value) || 0;
                totalCadastralSuperficie += value;
            });
            
            // Check if total exceeds limit
            const isOverLimit = totalCadastralSuperficie > maxSuperficie;
            
            // Add or remove error styling
            if (isOverLimit) {
                cadastralContainer.classList.add('superficie-error');
                
                // Show error message
                let errorMsg = document.getElementById('cadastral-error-msg');
                if (!errorMsg) {
                    errorMsg = document.createElement('div');
                    errorMsg.id = 'cadastral-error-msg';
                    errorMsg.className = 'error-message';
                    errorMsg.innerHTML = `‚ö†Ô∏è Errore: La somma delle superfici catastali (${totalCadastralSuperficie.toFixed(4)} ha) supera la superficie sottoparticella (${maxSuperficie.toFixed(4)} ha)`;
                    cadastralContainer.insertBefore(errorMsg, cadastralContainer.firstChild);
                } else {
                    errorMsg.innerHTML = `‚ö†Ô∏è Errore: La somma delle superfici catastali (${totalCadastralSuperficie.toFixed(4)} ha) supera la superficie sottoparticella (${maxSuperficie.toFixed(4)} ha)`;
                }
            } else {
                cadastralContainer.classList.remove('superficie-error');
                
                // Remove error message
                const errorMsg = document.getElementById('cadastral-error-msg');
                if (errorMsg) {
                    errorMsg.remove();
                }
            }
            
            return !isOverLimit;
        }

        // Add event listeners for existing species row
        document.addEventListener('DOMContentLoaded', function() {
            const speciesTable = document.querySelector('.species-table tbody');
            
            // Function to add calculation listeners to a row
            function addCalculationListeners(row) {
                const diameterField = row.querySelector('.diameter-field');
                const heightField = row.querySelector('.height-field');
                const volumeField = row.querySelector('.volume-field');
                const percentageField = row.querySelector('td:nth-child(2) input');
                
                if (diameterField && heightField && volumeField && percentageField) {
                    function updateVolume() {
                        calculateVolume(diameterField, heightField, volumeField);
                        calculateImd();
                        calculateImh();
                        calculateImv();
                    }
                    
                    function validateAndUpdateVolume() {
                        // Validate percentage first
                        validateTotalPercentage();
                        // Then update volume
                        calculateVolume(diameterField, heightField, volumeField);
                    }
                    
                    diameterField.addEventListener('input', updateVolume);
                    heightField.addEventListener('input', updateVolume);
                    percentageField.addEventListener('input', validateAndUpdateVolume);
                }
            }
            
            // Function to update all species volumes when global fields change
            function updateAllSpeciesVolumes() {
                const speciesRows = speciesTable.querySelectorAll('tr');
                speciesRows.forEach(row => {
                    const diameterField = row.querySelector('.diameter-field');
                    const heightField = row.querySelector('.height-field');
                    const volumeField = row.querySelector('.volume-field');
                    
                    if (diameterField && heightField && volumeField) {
                        // Call calculateVolume which will also update total volume
                        calculateVolume(diameterField, heightField, volumeField);
                    }
                });
                // Note: calculateTotalVolume is called by each calculateVolume call above
            }
            
            // Add listeners to existing rows
            const existingRows = speciesTable.querySelectorAll('tr');
            existingRows.forEach(addCalculationListeners);
            
            // Calculate all indices on page load
            calculateImd();
            calculateImh();
            calculateImv();
            calculateInterventionEta();
            calculateInterventionProvv();
            calculateInterventionRipresa();
            
            // Function to format existing volume fields to 2 decimals
            function formatExistingVolumeFields() {
                // Format all volume fields in species table
                const volumeFields = document.querySelectorAll('.volume-field');
                volumeFields.forEach(field => {
                    if (field.value && field.value !== '') {
                        const value = parseFloat(field.value);
                        if (!isNaN(value)) {
                            field.value = value.toFixed(2);
                        }
                    }
                });
                
                // Format all volume per hectare fields
                const volumePerHectareFields = document.querySelectorAll('.volume-per-hectare-field');
                volumePerHectareFields.forEach(field => {
                    if (field.value && field.value !== '') {
                        const value = parseFloat(field.value);
                        if (!isNaN(value)) {
                            field.value = value.toFixed(2);
                        }
                    }
                });
                
                // Format volume totale field
                const volumeTotaleField = document.getElementById('volume-totale');
                if (volumeTotaleField && volumeTotaleField.value && volumeTotaleField.value !== '') {
                    const value = parseFloat(volumeTotaleField.value);
                    if (!isNaN(value)) {
                        volumeTotaleField.value = value.toFixed(2);
                    }
                }
            }
            
            // Format existing volume fields to 2 decimals
            formatExistingVolumeFields();
            
            // Function to format superficie fields to 4 decimals using validateAndFormatDecimals
            function formatSuperficieFields() {
                // Format intervention superficie fields
                const interventionSuperficieFields = document.querySelectorAll('.intervention-superficie-field');
                interventionSuperficieFields.forEach(field => {
                    if (field.value && field.value !== '') {
                        validateAndFormatDecimals(field);
                    }
                });
                
                // Format cadastral superficie fields
                const cadastralSuperficieFields = document.querySelectorAll('.cadastral-superficie-field');
                cadastralSuperficieFields.forEach(field => {
                    if (field.value && field.value !== '') {
                        validateAndFormatDecimals(field);
                    }
                });
            }
            
            // Format existing superficie fields to 4 decimals
            formatSuperficieFields();
            
            // Add listeners to global fields that affect all species calculations
            const pianteEttaroField = document.getElementById('piante-ettaro');
            const superficieSottoField = document.getElementById('superficie-sottoparticella');
            
            if (pianteEttaroField) {
                pianteEttaroField.addEventListener('input', updateAllSpeciesVolumes);
            }
            
            if (superficieSottoField) {
                superficieSottoField.addEventListener('input', function() {
                    updateAllSpeciesVolumes();
                    calculateInterventionProvv();
                });
            }
            
            // Add listener to et√† field for all index calculations
            const etaField = document.getElementById('eta-soprassuolo');
            if (etaField) {
                etaField.addEventListener('input', function() {
                    calculateImd();
                    calculateImh();
                    calculateImv();
                    calculateInterventionEta();
                    calculateInterventionProvv();
                    calculateInterventionRipresa();
                });
            }
            
            // Add listener to anno rilievo field for intervention et√† calculation
            const annoRilievoField = document.getElementById('anno-rilievo');
            if (annoRilievoField) {
                annoRilievoField.addEventListener('input', function() {
                    calculateInterventionEta();
                    calculateInterventionProvv();
                });
            }
            
            // Function to add intervention calculation listeners to a row
            function addInterventionCalculationListeners(row) {
                const annoInterventoField = row.querySelector('.intervention-anno-field');
                const superficieInterventoField = row.querySelector('.intervention-superficie-field');
                
                if (annoInterventoField) {
                    annoInterventoField.addEventListener('input', function() {
                        calculateInterventionEta();
                        calculateInterventionProvv();
                        calculateInterventionRipresa();
                    });
                }
                
                if (superficieInterventoField) {
                    superficieInterventoField.addEventListener('input', function() {
                        calculateInterventionRipresa();
                    });
                }
            }
            
            // Add listeners to existing intervention rows
            const interventionTable = document.querySelector('.intervention-table tbody');
            if (interventionTable) {
                const existingInterventionRows = interventionTable.querySelectorAll('tr');
                existingInterventionRows.forEach(addInterventionCalculationListeners);
            }
            
            // Add listener to intensit√† intervento field for Provv calculation
            const intensitaInterventoField = document.getElementById('intensita-intervento');
            if (intensitaInterventoField) {
                intensitaInterventoField.addEventListener('input', calculateInterventionProvv);
            }
            
            // Add listener to superficie sottoparticella for cadastral validation
            if (superficieSottoField) {
                superficieSottoField.addEventListener('input', validateCadastralSuperficie);
            }
            
            // Add listeners to existing cadastral superficie fields
            function addCadastralValidationListeners() {
                const cadastralSuperficieFields = document.querySelectorAll('.cadastral-superficie-field');
                cadastralSuperficieFields.forEach(field => {
                    field.addEventListener('input', validateCadastralSuperficie);
                });
            }
            
            // Add validation listeners to existing cadastral fields
            addCadastralValidationListeners();
            
            
            // Add superficie formatting listeners EXACTLY like superficie-sottoparticella
            console.log('Adding superficie formatting listeners...');
            
            // Format intervention superficie fields with BOTH input and blur (copying superficie-sottoparticella pattern)
            const allInterventionSuperficieFields = document.querySelectorAll('.intervention-superficie-field');
            console.log('Found intervention superficie fields:', allInterventionSuperficieFields.length);
            allInterventionSuperficieFields.forEach(field => {
                // Add input listener for real-time validation (like superficie-sottoparticella)
                field.addEventListener('input', function(e) {
                    const value = e.target.value;
                    // Allow only numbers, dots, and commas
                    const sanitized = value.replace(/[^0-9.,]/g, '');
                    if (sanitized !== value) {
                        e.target.value = sanitized;
                    }
                });
                
                // Add blur listener for final formatting (like superficie-sottoparticella)
                field.addEventListener('blur', function() {
                    console.log('Formatting intervention superficie field...');
                    validateAndFormatDecimals(this);
                });
            });
            
            // Format cadastral superficie fields with BOTH input and blur (copying superficie-sottoparticella pattern)
            const allCadastralSuperficieFields = document.querySelectorAll('.cadastral-superficie-field');
            console.log('Found cadastral superficie fields:', allCadastralSuperficieFields.length);
            allCadastralSuperficieFields.forEach(field => {
                // Add input listener for real-time validation (like superficie-sottoparticella)
                field.addEventListener('input', function(e) {
                    const value = e.target.value;
                    // Allow only numbers, dots, and commas
                    const sanitized = value.replace(/[^0-9.,]/g, '');
                    if (sanitized !== value) {
                        e.target.value = sanitized;
                    }
                });
                
                // Add blur listener for final formatting (like superficie-sottoparticella)
                field.addEventListener('blur', function() {
                    console.log('Formatting cadastral superficie field...');
                    validateAndFormatDecimals(this);
                });
            });
            
            // Validate cadastral superficie on page load
            validateCadastralSuperficie();
            
            // Override the add-species button to include calculation listeners
            const originalAddSpeciesHandler = document.getElementById('add-species').onclick;
            document.getElementById('add-species').addEventListener('click', function() {
                // Wait for the new row to be added
                setTimeout(function() {
                    const newRows = speciesTable.querySelectorAll('tr');
                    const newRow = newRows[newRows.length - 1];
                    addCalculationListeners(newRow);
                    calculateImd();
                    calculateImh();
                    calculateImv();
                }, 10);
            });
        });

    </script>
</body>
</html>