<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheda di Rilievo Forestale</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8FBC8F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="assets/icons/icon-192x192.png">
</head>
<body>
    <!-- Home Page -->
    <div id="home-page" class="home-container">
        <header class="home-header">
            <h1>DB Forestale</h1>
            <p>Sistema di gestione dati forestali</p>
        </header>

        <main class="home-main">
            <div class="home-buttons">
                <button type="button" id="new-project-btn" class="home-btn home-btn-primary">
                    <span class="btn-icon">üìã</span>
                    <span class="btn-text">Crea nuovo progetto</span>
                </button>
                
                <button type="button" id="load-project-btn" class="home-btn home-btn-secondary">
                    <span class="btn-icon">üìÅ</span>
                    <span class="btn-text">Carica progetto</span>
                </button>
                
                <button type="button" id="manage-projects-btn" class="home-btn home-btn-secondary">
                    <span class="btn-icon">üìä</span>
                    <span class="btn-text">Gestione progetti</span>
                </button>
                
                <button type="button" id="settings-btn" class="home-btn home-btn-secondary">
                    <span class="btn-icon">‚öôÔ∏è</span>
                    <span class="btn-text">Impostazioni</span>
                </button>
                
                <button type="button" id="guide-btn" class="home-btn home-btn-secondary">
                    <span class="btn-icon">‚ùì</span>
                    <span class="btn-text">Guida</span>
                </button>
            </div>
        </main>
    </div>

    <!-- Project Creation Modal -->
    <div id="project-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crea nuovo progetto</h2>
            </div>
            <div class="modal-body">
                <form id="project-form">
                    <div class="form-group">
                        <label for="project-name">Nome del progetto</label>
                        <input type="text" id="project-name" name="project-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-location">Location</label>
                        <input type="text" id="project-location" name="project-location" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-client">Committente</label>
                        <input type="text" id="project-client" name="project-client" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="project-authority">Ente di riferimento</label>
                        <input type="text" id="project-authority" name="project-authority" required>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" id="start-project-btn" class="modal-btn modal-btn-primary">Avvia il progetto</button>
                <button type="button" id="cancel-project-btn" class="modal-btn modal-btn-secondary">Annulla progetto</button>
            </div>
        </div>
    </div>

    <!-- Project Overview Page (initially hidden) -->
    <div id="project-page" class="project-container hidden">
        <header class="project-header">
            <h1>Progetto</h1>
            <button id="back-to-home-btn" class="back-btn">‚Üê Torna alla home</button>
        </header>

        <div class="project-details">
            <div class="project-info-card">
                <h2>Dettagli Progetto</h2>
                <div class="project-info">
                    <div class="info-item">
                        <label>Nome del progetto:</label>
                        <span id="display-project-name"></span>
                    </div>
                    <div class="info-item">
                        <label>Location:</label>
                        <span id="display-project-location"></span>
                    </div>
                    <div class="info-item">
                        <label>Committente:</label>
                        <span id="display-project-client"></span>
                    </div>
                    <div class="info-item">
                        <label>Ente di riferimento:</label>
                        <span id="display-project-authority"></span>
                    </div>
                </div>
            </div>

            <div class="particella-actions">
                <button type="button" id="add-particella-btn" class="btn btn-primary">
                    <span class="btn-icon">üìã</span>
                    Aggiungi particella
                </button>
            </div>

            <div class="particella-list">
                <h3>Particelle del Progetto</h3>
                <div class="particella-table-container">
                    <table class="particella-table">
                        <thead>
                            <tr>
                                <th>Particella</th>
                                <th>Sub. part.</th>
                                <th>Superficie (ha)</th>
                                <th>Specie</th>
                                <th>Intervento Programmato</th>
                                <th>Anno</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="particella-table-body">
                            <!-- Particella rows will be added here dynamically -->
                        </tbody>
                    </table>
                    <div id="empty-particelle-message" class="empty-message">
                        Nessuna particella ancora aggiunta al progetto
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form (initially hidden) -->
    <div id="main-form" class="container hidden">
        <header class="form-header">
            <h1>SCHEDA DI RILIEVO</h1>
            <div class="db-key">Chiave db: <input type="text" id="chiave-db" maxlength="5" placeholder=""></div>
        </header>

        <form id="forestry-form">
            <!-- Sezione identificazione particella -->
            <section class="form-section">
                <div class="section-header">Inquadramento generale</div>
                <div class="inquadramento-layout">
                    <div class="inquadramento-left">
                        <div class="inquadramento-row">
                            <label for="particella">Particella (PF) n.</label>
                            <input type="text" id="particella" name="particella" maxlength="3">
                        </div>
                        <div class="inquadramento-row">
                            <label for="sottoparticella">Sottoparticella (SPF) n.</label>
                            <input type="text" id="sottoparticella" name="sottoparticella" maxlength="2">
                        </div>
                        <div class="inquadramento-row">
                            <label for="localita">Localit√†</label>
                            <input type="text" id="localita" name="localita">
                        </div>
                    </div>
                    <div class="inquadramento-right">
                        <div class="inquadramento-row">
                            <label for="superficie-particella">Superficie particella (ha)</label>
                            <input type="number" step="0.0001" max="999.9999" id="superficie-particella" name="superficie-particella">
                        </div>
                        <div class="inquadramento-row">
                            <label for="superficie-sottoparticella">Superficie sottoparticella (ha)</label>
                            <input type="number" step="0.0001" max="999.9999" id="superficie-sottoparticella" name="superficie-sottoparticella">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Caratteristiche stazionali e infrastrutture -->
            <section class="form-section">
                <div class="dual-column">
                    <div class="left-column">
                        <div class="section-header">Caratteristiche stazionali</div>
                        <div class="field-group">
                            <label for="esposizione">Esposizione</label>
                            <select id="esposizione" name="esposizione">
                                <option value="">Seleziona...</option>
                                <option value="N">N</option>
                                <option value="NE">NE</option>
                                <option value="E">E</option>
                                <option value="SE">SE</option>
                                <option value="S">S</option>
                                <option value="SW">SW</option>
                                <option value="W">W</option>
                                <option value="NW">NW</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="altitudine">Altitudine (m)</label>
                            <input type="number" id="altitudine" name="altitudine" max="9999" step="1">
                        </div>
                        <div class="field-group">
                            <label for="pendenza">Pendenza (%)</label>
                            <div class="input-with-unit">
                                <input type="number" step="1" max="99" id="pendenza" name="pendenza">
                                <span class="unit">%</span>
                            </div>
                        </div>
                        <div class="field-group">
                            <label for="fertilita">Fertilit√† della stazione</label>
                            <select id="fertilita" name="fertilita">
                                <option value="">Seleziona...</option>
                                <option value="Scarsa">Scarsa</option>
                                <option value="Bassa">Bassa</option>
                                <option value="Media">Media</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                    </div>
                    <div class="right-column">
                        <div class="section-header">Infrastrutture forestali</div>
                        <div class="infrastructure-container">
                            <div class="field-group">
                                <label for="viabilita">Viabilit√† e imposti</label>
                                <div class="input-with-delete">
                                    <select id="viabilita" name="viabilita">
                                        <option value="">Seleziona...</option>
                                        <option value="Strada camionabile principale">Strada camionabile principale</option>
                                        <option value="Strada camionabile secondaria">Strada camionabile secondaria</option>
                                        <option value="Strada trattorabile">Strada trattorabile</option>
                                        <option value="Pista camionabile">Pista camionabile</option>
                                        <option value="Pista principale per trattori">Pista principale per trattori</option>
                                        <option value="Pista secondaria per trattori">Pista secondaria per trattori</option>
                                        <option value="Linee di esbosco">Linee di esbosco</option>
                                        <option value="Imposto permanente">Imposto permanente</option>
                                        <option value="Imposto temporaneo">Imposto temporaneo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="button" id="add-infrastruttura-btn" class="add-row-btn add-infrastruttura-btn">+ Aggiungi infrastruttura</button>
                    </div>
                </div>
            </section>

            <!-- Caratterizzazione della particella -->
            <section class="form-section">
                <div class="section-header">Caratterizzazione della particella</div>
                <div class="dual-column">
                    <div class="left-column">
                        <div class="field-group">
                            <label for="forma-governo">Forma di governo</label>
                            <select id="forma-governo" name="forma-governo">
                                <option value="">Seleziona...</option>
                                <option value="Ceduo">Ceduo</option>
                                <option value="Fustaia">Fustaia</option>
                                <option value="Neoformazione">Neoformazione</option>
                                <option value="Non definita">Non definita</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="composizione">Composizione</label>
                            <select id="composizione" name="composizione">
                                <option value="">Seleziona...</option>
                                <option value="Puro">Puro</option>
                                <option value="A prevalenza">A prevalenza</option>
                                <option value="Misto">Misto</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="compresa-forestale">Compresa forestale</label>
                            <input type="text" id="compresa-forestale" name="compresa-forestale">
                        </div>
                    </div>
                    <div class="right-column">
                        <div class="field-group">
                            <label for="grado-evolutivo">Grado evolutivo</label>
                            <select id="grado-evolutivo" name="grado-evolutivo">
                                <option value="">Seleziona...</option>
                                <option value="Ceduo a regime">Ceduo a regime</option>
                                <option value="Ceduo invecchiato">Ceduo invecchiato</option>
                                <option value="Fustaia giovane">Fustaia giovane</option>
                                <option value="Fustaia adulta">Fustaia adulta</option>
                                <option value="Fustaia matura">Fustaia matura</option>
                                <option value="Novelletto">Novelletto</option>
                                <option value="Perticaia">Perticaia</option>
                                <option value="Posticcia">Posticcia</option>
                                <option value="Spessina">Spessina</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="tipo-colturale">Tipo colturale</label>
                            <select id="tipo-colturale" name="tipo-colturale">
                                <option value="">Seleziona...</option>
                                <option value="Ceduo semplice">Ceduo semplice</option>
                                <option value="Ceduo intensamente matricinato">Ceduo intensamente matricinato</option>
                                <option value="Ceduo composto">Ceduo composto</option>
                                <option value="Ceduo a sterzo">Ceduo a sterzo</option>
                                <option value="Ceduo coniferato">Ceduo coniferato</option>
                                <option value="Fustaia coetanea">Fustaia coetanea</option>
                                <option value="Fustaia transitoria">Fustaia transitoria</option>
                                <option value="Fustaia irregolare">Fustaia irregolare</option>
                                <option value="Fustaia disetanea">Fustaia disetanea</option>
                                <option value="Fustaia su ceduo">Fustaia su ceduo</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="destinazione">Destinazione</label>
                            <select id="destinazione" name="destinazione">
                                <option value="">Seleziona...</option>
                                <option value="Produttiva">Produttiva</option>
                                <option value="Paesaggistica">Paesaggistica</option>
                                <option value="Naturalistica">Naturalistica</option>
                                <option value="Scientifica">Scientifica</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field-group full-width">
                    <label for="tipo-forestale">Tipo forestale</label>
                    <select id="tipo-forestale" name="tipo-forestale">
                        <option value="">Seleziona...</option>
                        <option value="1.1. Lecceta tipica a Viburnum tinus">1.1. Lecceta tipica a Viburnum tinus</option>
                        <option value="1.2. Lecceta di transizione a boschi di caducifoglie">1.2. Lecceta di transizione a boschi di caducifoglie</option>
                        <option value="1.3. Orno-lecceta con roverella delle zone interne">1.3. Orno-lecceta con roverella delle zone interne</option>
                        <option value="1.4. Lecceta rupicola relitta submontana e montana">1.4. Lecceta rupicola relitta submontana e montana</option>
                        <option value="2.1. Macchia media mesoditerranea">2.1. Macchia media mesoditerranea</option>
                        <option value="2.2. Macchia bassa mesomediterranea">2.2. Macchia bassa mesomediterranea</option>
                        <option value="2.3. Macchia termomediterranea">2.3. Macchia termomediterranea</option>
                        <option value="2.4. Macchia rupestre a Olea europaea sylvestris ed Euphorbia dendroides">2.4. Macchia rupestre a Olea europaea sylvestris ed Euphorbia dendroides</option>
                        <option value="2.5. Ginepreto dunale a Juniperus macrocarpa e J. phoenicea">2.5. Ginepreto dunale a Juniperus macrocarpa e J. phoenicea</option>
                        <option value="2.6. Ginepreto rupestre a Juniperus phoenicea">2.6. Ginepreto rupestre a Juniperus phoenicea</option>
                        <option value="2.7. Boscaglia di consolidamento dunale a tamerici">2.7. Boscaglia di consolidamento dunale a tamerici</option>
                        <option value="3.1. Sughereta mista sopra ceduo di leccio e altre sempreverdi">3.1. Sughereta mista sopra ceduo di leccio e altre sempreverdi</option>
                        <option value="3.2. Sughereta mista sopra ceduo di sempreverdi e caducifoglie">3.2. Sughereta mista sopra ceduo di sempreverdi e caducifoglie</option>
                        <option value="3.3. Sughereta specializzata">3.3. Sughereta specializzata</option>
                        <option value="4.1. Pineta costiera di pino d'Aleppo">4.1. Pineta costiera di pino d'Aleppo</option>
                        <option value="4.2. Pineta di pino d'Aleppo di rimboschimento">4.2. Pineta di pino d'Aleppo di rimboschimento</option>
                        <option value="5.1. Pineta dunale mesomediterranea di pino domestico">5.1. Pineta dunale mesomediterranea di pino domestico</option>
                        <option value="5.2. Pineta dunale termomediterranea di pino domestico">5.2. Pineta dunale termomediterranea di pino domestico</option>
                        <option value="5.3. Pineta dunale di pino domestico a leccio">5.3. Pineta dunale di pino domestico a leccio</option>
                        <option value="5.4. Pineta planiziale mesoigrofila di pino domestico">5.4. Pineta planiziale mesoigrofila di pino domestico</option>
                        <option value="5.5. Pineta collinare di pino domestico a eriche e cisti">5.5. Pineta collinare di pino domestico a eriche e cisti</option>
                        <option value="5.6. Pineta collinare di pino domestico a roverella con arbusti del Pruneto">5.6. Pineta collinare di pino domestico a roverella con arbusti del Pruneto</option>
                        <option value="6.1. Pineta di clima suboceanico di pino marittimo a Ulex europaeus">6.1. Pineta di clima suboceanico di pino marittimo a Ulex europaeus</option>
                        <option value="6.2. Pineta sopramediterranea di pino marittimo">6.2. Pineta sopramediterranea di pino marittimo</option>
                        <option value="6.3. Pineta mediterranea di pino marittimo su macchia acidofila">6.3. Pineta mediterranea di pino marittimo su macchia acidofila</option>
                        <option value="6.4. Pineta costiera di pino marittimo">6.4. Pineta costiera di pino marittimo</option>
                        <option value="6.5. Pineta di pino marittimo su ofioliti">6.5. Pineta di pino marittimo su ofioliti</option>
                        <option value="7.1. Cipresseta a roverella e Spartium junceum">7.1. Cipresseta a roverella e Spartium junceum</option>
                        <option value="7.2. Cipresseta su gramineto xerofilo">7.2. Cipresseta su gramineto xerofilo</option>
                        <option value="8.1. Alneto igrofilo e mesoigrofilo di ontano nero e frassino meridionale">8.1. Alneto igrofilo e mesoigrofilo di ontano nero e frassino meridionale</option>
                        <option value="8.2. Bosco interdunale di pioppi con farnia e frassino meridionale">8.2. Bosco interdunale di pioppi con farnia e frassino meridionale</option>
                        <option value="8.3 Querco-carpineto extrazonale di farnia.">8.3 Querco-carpineto extrazonale di farnia.</option>
                        <option value="9.1. Saliceto e pioppeto ripario">9.1. Saliceto e pioppeto ripario</option>
                        <option value="9.2 Alneto ripario di ontano nero">9.2 Alneto ripario di ontano nero</option>
                        <option value="10.1. Querceto mesotermofilo di roverella a Rosa sempervirens">10.1. Querceto mesotermofilo di roverella a Rosa sempervirens</option>
                        <option value="10.2. Querceto mesofilo di roverella e cerro">10.2. Querceto mesofilo di roverella e cerro</option>
                        <option value="10.3. Querceto mesoxerofilo di roverella a Cytisus sessilifolius">10.3. Querceto mesoxerofilo di roverella a Cytisus sessilifolius</option>
                        <option value="10.4. Querceto acidofilo di roverella a cerro">10.4. Querceto acidofilo di roverella a cerro</option>
                        <option value="10.5. Querceto termofilo di roverella con leccio e cerro">10.5. Querceto termofilo di roverella con leccio e cerro</option>
                        <option value="11.1. Cerreta eutrofica ad Acer opalus s.l.">11.1. Cerreta eutrofica ad Acer opalus s.l.</option>
                        <option value="11.2.Cerreta mesofila collinare">11.2.Cerreta mesofila collinare</option>
                        <option value="11.3. Cerreta mesoxerofila">11.3. Cerreta mesoxerofila</option>
                        <option value="11.4. Cerreta acidofila montana">11.4. Cerreta acidofila montana</option>
                        <option value="11.5.Cerreta acidofila dei terrazzi a paleosuoli">11.5.Cerreta acidofila dei terrazzi a paleosuoli</option>
                        <option value="11.6. Cerreta acidofila submediterranea a eriche">11.6. Cerreta acidofila submediterranea a eriche</option>
                        <option value="11.7. Cerreta mesofila planiziale">11.7. Cerreta mesofila planiziale</option>
                        <option value="11.8. Cerreta termoigrofila mediterranea">11.8. Cerreta termoigrofila mediterranea</option>
                        <option value="11.9 Querceto di cerro e farnetto a Pulicaria odora">11.9 Querceto di cerro e farnetto a Pulicaria odora</option>
                        <option value="12.1. Carpino-querceto mesofilo di cerro con rovere">12.1. Carpino-querceto mesofilo di cerro con rovere</option>
                        <option value="12.2. Querceto acidofilo di rovere e cerro">12.2. Querceto acidofilo di rovere e cerro</option>
                        <option value="12.3. Carpineto misto collinare (-submontano) a cerro">12.3. Carpineto misto collinare (-submontano) a cerro</option>
                        <option value="13.1. Ostrieto pioniero dei calcari duri delle Apuane">13.1. Ostrieto pioniero dei calcari duri delle Apuane</option>
                        <option value="13.2. Ostrieto mesofilo a Sesleria argentea delle Apuane">13.2. Ostrieto mesofilo a Sesleria argentea delle Apuane</option>
                        <option value="13.3. Ostrieto pioniero delle balze marnoso-arenacee appenniniche">13.3. Ostrieto pioniero delle balze marnoso-arenacee appenniniche</option>
                        <option value="13.4. Ostrieto delle aree calanchive delle alte valli dell'Arno e del Tevere">13.4. Ostrieto delle aree calanchive delle alte valli dell'Arno e del Tevere</option>
                        <option value="13.5. Ostrieto termofilo dei calcari marnosi ad Asparagus acutifolius">13.5. Ostrieto termofilo dei calcari marnosi ad Asparagus acutifolius</option>
                        <option value="13.6. Ostrieto mesofilo dei substrati silicatici">13.6. Ostrieto mesofilo dei substrati silicatici</option>
                        <option value="14.1. Castagneto mesofilo su arenaria">14.1. Castagneto mesofilo su arenaria</option>
                        <option value="14.2. Castagneto mesotrofico su rocce vulcaniche del Monte Amiata">14.2. Castagneto mesotrofico su rocce vulcaniche del Monte Amiata</option>
                        <option value="14.3. Castagneto acidofilo">14.3. Castagneto acidofilo</option>
                        <option value="14.4. Castagneto neutrofilo su rocce calcaree e scisti marnosi">14.4. Castagneto neutrofilo su rocce calcaree e scisti marnosi</option>
                        <option value="15.1. Robinieto d'impianto">15.1. Robinieto d'impianto</option>
                        <option value="16.1. Betuleto misto">16.1. Betuleto misto</option>
                        <option value="17.1. Alneto autoctono di ontano bianco">17.1. Alneto autoctono di ontano bianco</option>
                        <option value="17.2. Alneto d'impianto di ontano napoletano">17.2. Alneto d'impianto di ontano napoletano</option>
                        <option value="18.1. Pineta eutrofica (acidofila) di pino nero">18.1. Pineta eutrofica (acidofila) di pino nero</option>
                        <option value="18.2. Pineta neutro-acidoclina di pino nero">18.2. Pineta neutro-acidoclina di pino nero</option>
                        <option value="18.3. Pineta neutro-basifila di pino nero">18.3. Pineta neutro-basifila di pino nero</option>
                        <option value="19. Impianti di douglasia">19. Impianti di douglasia</option>
                        <option value="20.1. Pteridieto">20.1. Pteridieto</option>
                        <option value="20.2. Pruneto">20.2. Pruneto</option>
                        <option value="20.3. Ginestreto collinare di Spartium junceum">20.3. Ginestreto collinare di Spartium junceum</option>
                        <option value="20.4. Ginepreto di Juniperus communis">20.4. Ginepreto di Juniperus communis</option>
                        <option value="20.5. Ginestreto Cytisus scoparius">20.5. Ginestreto Cytisus scoparius</option>
                        <option value="20.6. Calluneto di quota">20.6. Calluneto di quota</option>
                        <option value="21.1. Abetina altimontana di origine artificiale">21.1. Abetina altimontana di origine artificiale</option>
                        <option value="21.2. Abetina montana di origine artificiale">21.2. Abetina montana di origine artificiale</option>
                        <option value="21.3. Abetina sotto quota di origine aritificiale">21.3. Abetina sotto quota di origine aritificiale</option>
                        <option value="21.4. Abetina mista autoctona del monte Amiata">21.4. Abetina mista autoctona del monte Amiata</option>
                        <option value="21.5. Piceo-abieteto autoctono con faggio dell'Abetone">21.5. Piceo-abieteto autoctono con faggio dell'Abetone</option>
                        <option value="22.1. Faggeta eutrofica a dentarie">22.1. Faggeta eutrofica a dentarie</option>
                        <option value="22.2. Faggeta appenninica mesotrofica a Geranium nodosum e Luzula nivea">22.2. Faggeta appenninica mesotrofica a Geranium nodosum e Luzula nivea</option>
                        <option value="22.3. Faggeta oligotrofica a Luzula pedemontana, Luzula nivea e Festuca heterophylla">22.3. Faggeta oligotrofica a Luzula pedemontana, Luzula nivea e Festuca heterophylla</option>
                        <option value="22.4. Aceri-faggeto appenninico di quota">22.4. Aceri-faggeto appenninico di quota</option>
                        <option value="22.5. Faggeta cespugliosa di vetta">22.5. Faggeta cespugliosa di vetta</option>
                        <option value="22.6. Faggeta apuana a Sesleria argentea">22.6. Faggeta apuana a Sesleria argentea</option>
                        <option value="22.7. Faggeta amiatina inferiore">22.7. Faggeta amiatina inferiore</option>
                        <option value="22.8. Faggeta amiatina superiore ad Adenostyles australis">22.8. Faggeta amiatina superiore ad Adenostyles australis</option>
                        <option value="22.9. Aceri-frassineto">22.9. Aceri-frassineto</option>
                        <option value="23.1. Ontano napoletano">23.1. Ontano napoletano</option>
                        <option value="23.2. Cedro dell'Atlante">23.2. Cedro dell'Atlante</option>
                        <option value="23.4. Cipresso dell'Arizona">23.4. Cipresso dell'Arizona</option>
                        <option value="23.5. Larice giapponese">23.5. Larice giapponese</option>
                        <option value="23.6. Larice europeo">23.6. Larice europeo</option>
                        <option value="23.7. Quercia rossa">23.7. Quercia rossa</option>
                        <option value="23.8. Abete greco">23.8. Abete greco</option>
                        <option value="23.9. Pino strobo">23.9. Pino strobo</option>
                        <option value="23.10. Pino eccelso">23.10. Pino eccelso</option>
                        <option value="23.11. Eucalipti">23.11. Eucalipti</option>
                    </select>
                </div>
            </section>

            <!-- Descrizione del soprassuolo -->
            <section class="form-section">
                <div class="section-header">Descrizione del soprassuolo</div>
                <div class="row">
                    <div class="field-group">
                        <label for="anno-rilievo">Anno rilievo</label>
                        <input type="number" id="anno-rilievo" name="anno-rilievo" min="1900" max="9999" step="1">
                    </div>
                    <div class="field-group">
                        <label for="piante-ettaro">Piante ad ettaro</label>
                        <input type="number" id="piante-ettaro" name="piante-ettaro" max="999999" step="1">
                    </div>
                    <div class="field-group">
                        <label for="eta-soprassuolo">Et√† del soprassuolo</label>
                        <input type="number" id="eta-soprassuolo" name="eta-soprassuolo" max="999" step="1">
                    </div>
                </div>
                <div class="row">
                    <div class="field-group">
                        <label for="copertura">Copertura (%)</label>
                        <div class="input-with-unit">
                            <input type="number" step="1" max="100" id="copertura" name="copertura">
                            <span class="unit">%</span>
                        </div>
                    </div>
                </div>

                <!-- Tabella specie -->
                <div class="species-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Specie</th>
                                <th>%</th>
                                <th>d (cm)</th>
                                <th>h (m)</th>
                                <th>V</th>
                                <th>Vt/ha (mc)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <select>
                                        <option value="">Seleziona specie...</option>
                                        <option value="Abete bianco (Abies alba)">Abete bianco <em>(Abies alba)</em></option>
                                        <option value="Abete rosso (Picea abies)">Abete rosso <em>(Picea abies)</em></option>
                                        <option value="Acero campestre (Acer campestre)">Acero campestre <em>(Acer campestre)</em></option>
                                        <option value="Acero di monte (Acer pseudoplatanus)">Acero di monte <em>(Acer pseudoplatanus)</em></option>
                                        <option value="Acero opalo (Acer opalus)">Acero opalo <em>(Acer opalus)</em></option>
                                        <option value="Acero riccio (Acer lobelii)">Acero riccio <em>(Acer lobelii)</em></option>
                                        <option value="Acero tribolo (Acer tataricum)">Acero tribolo <em>(Acer tataricum)</em></option>
                                        <option value="Ailanto (Ailanthus altissima)">Ailanto <em>(Ailanthus altissima)</em></option>
                                        <option value="Betulla (Betula pendula)">Betulla <em>(Betula pendula)</em></option>
                                        <option value="Carpino bianco (Carpinus betulus)">Carpino bianco <em>(Carpinus betulus)</em></option>
                                        <option value="Carpino nero (Ostrya carpinifolia)">Carpino nero <em>(Ostrya carpinifolia)</em></option>
                                        <option value="Castagno (Castanea sativa)">Castagno <em>(Castanea sativa)</em></option>
                                        <option value="Cedro dell'Atlante (Cedrus atlantica)">Cedro dell'Atlante <em>(Cedrus atlantica)</em></option>
                                        <option value="Cedro deodara (Cedrus deodara)">Cedro deodara <em>(Cedrus deodara)</em></option>
                                        <option value="Cedro del Libano (Cedrus libani)">Cedro del Libano <em>(Cedrus libani)</em></option>
                                        <option value="Cerro (Quercus cerris)">Cerro <em>(Quercus cerris)</em></option>
                                        <option value="Chamaecyparis (Chamaecyparis sp)">Chamaecyparis <em>(Chamaecyparis sp)</em></option>
                                        <option value="Ciavardello (Quercus robur)">Ciavardello <em>(Quercus robur)</em></option>
                                        <option value="Ciliegio (Prunus avium)">Ciliegio <em>(Prunus avium)</em></option>
                                        <option value="Cipresso comune (Cupressus sempervirens)">Cipresso comune <em>(Cupressus sempervirens)</em></option>
                                        <option value="Cipresso dell'Arizona (Cupressus arizonica)">Cipresso dell'Arizona <em>(Cupressus arizonica)</em></option>
                                        <option value="Cipresso di Monterey (Cupressus macrocarpa)">Cipresso di Monterey <em>(Cupressus macrocarpa)</em></option>
                                        <option value="Corbezzolo (Arbutus unedo)">Corbezzolo <em>(Arbutus unedo)</em></option>
                                        <option value="Douglasia (Pseudotsuga menziesii)">Douglasia <em>(Pseudotsuga menziesii)</em></option>
                                        <option value="Faggio (Fagus sylvatica)">Faggio <em>(Fagus sylvatica)</em></option>
                                        <option value="Farnetto (Fraxinus ornus)">Farnetto <em>(Fraxinus ornus)</em></option>
                                        <option value="Farnia (Fraxinus excelsior)">Farnia <em>(Fraxinus excelsior)</em></option>
                                        <option value="Frassino maggiore (Fraxinus angustifolia)">Frassino maggiore <em>(Fraxinus angustifolia)</em></option>
                                        <option value="Frassino ossifillo (Fraxinus oxycarpa)">Frassino ossifillo <em>(Fraxinus oxycarpa)</em></option>
                                        <option value="Ippocastano (Aesculus hippocastanum)">Ippocastano <em>(Aesculus hippocastanum)</em></option>
                                        <option value="Leccio (Quercus ilex)">Leccio <em>(Quercus ilex)</em></option>
                                        <option value="Nocciolo (Corylus avellana)">Nocciolo <em>(Corylus avellana)</em></option>
                                        <option value="Noce (Juglans regia)">Noce <em>(Juglans regia)</em></option>
                                        <option value="Ontano bianco (Alnus incana)">Ontano bianco <em>(Alnus incana)</em></option>
                                        <option value="Ontano napoletano (Alnus cordata)">Ontano napoletano <em>(Alnus cordata)</em></option>
                                        <option value="Ontano nero (Alnus glutinosa)">Ontano nero <em>(Alnus glutinosa)</em></option>
                                        <option value="Orniello (Fraxinus ornus)">Orniello <em>(Fraxinus ornus)</em></option>
                                        <option value="Pino d'Aleppo (Pinus halepensis)">Pino d'Aleppo <em>(Pinus halepensis)</em></option>
                                        <option value="Pino domestico (Pinus pinea)">Pino domestico <em>(Pinus pinea)</em></option>
                                        <option value="Pino insigne (Pinus radiata)">Pino insigne <em>(Pinus radiata)</em></option>
                                        <option value="Pino loricato (Pinus heldreichii)">Pino loricato <em>(Pinus heldreichii)</em></option>
                                        <option value="Pino marittimo (Pinus pinaster)">Pino marittimo <em>(Pinus pinaster)</em></option>
                                        <option value="Pino nero (Pinus nigra)">Pino nero <em>(Pinus nigra)</em></option>
                                        <option value="Pino silvestre (Pinus sylvestris)">Pino silvestre <em>(Pinus sylvestris)</em></option>
                                        <option value="Pioppo bianco (Populus alba)">Pioppo bianco <em>(Populus alba)</em></option>
                                        <option value="Pioppo cinerino (Populus cinerea)">Pioppo cinerino <em>(Populus cinerea)</em></option>
                                        <option value="Pioppo nero (Populus nigra)">Pioppo nero <em>(Populus nigra)</em></option>
                                        <option value="Pioppo tremulo (Populus tremula)">Pioppo tremulo <em>(Populus tremula)</em></option>
                                        <option value="Robinia (Robinia pseudoacacia)">Robinia <em>(Robinia pseudoacacia)</em></option>
                                        <option value="Rovere (Quercus robur)">Rovere <em>(Quercus robur)</em></option>
                                        <option value="Roverella (Quercus petraea)">Roverella <em>(Quercus petraea)</em></option>
                                        <option value="Salice (Salix spp)">Salice <em>(Salix spp)</em></option>
                                        <option value="Sorbo degli uccellatori (Sorbus aucuparia)">Sorbo degli uccellatori <em>(Sorbus aucuparia)</em></option>
                                        <option value="Sorbo domestico (Sorbus domestica)">Sorbo domestico <em>(Sorbus domestica)</em></option>
                                        <option value="Sughera (Quercus suber)">Sughera <em>(Quercus suber)</em></option>
                                        <option value="Tasso (Taxus baccata)">Tasso <em>(Taxus baccata)</em></option>
                                        <option value="Thuja (Thuja occidentalis)">Thuja <em>(Thuja occidentalis)</em></option>
                                        <option value="Tiglio (Tilia cordata)">Tiglio <em>(Tilia cordata)</em></option>
                                    </select>
                                </td>
                                <td><input type="number" step="1" max="99" class="no-spinner"></td>
                                <td><input type="number" step="1" max="999" class="no-spinner"></td>
                                <td><input type="number" step="1" max="999" class="no-spinner"></td>
                                <td><input type="number" step="0.01" max="9999.99"></td>
                                <td><input type="number" step="0.01"></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" id="add-species" class="add-row-btn">+ Aggiungi specie</button>
                </div>

                <!-- Calcoli volume -->
                <div class="volume-calculations">
                    <div class="row">
                        <div class="field-group">
                            <label for="volume-totale">Volume totale (mc)</label>
                            <input type="number" step="0.01" max="9999.99" id="volume-totale" name="volume-totale" readonly>
                        </div>
                        <div class="field-group">
                            <label for="imd">Imd</label>
                            <input type="number" step="0.1" max="99.9" id="imd" name="imd" readonly>
                        </div>
                        <div class="field-group">
                            <label for="imh">Imh</label>
                            <input type="number" step="0.1" max="99.9" id="imh" name="imh" readonly>
                        </div>
                        <div class="field-group">
                            <label for="imv">Imv</label>
                            <input type="number" step="0.1" max="99.9" id="imv" name="imv" readonly>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Registro interventi -->
            <section class="form-section">
                <div class="section-header">Registro interventi</div>
                <div class="ultimo-intervento-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Ultimo intervento effettuato</th>
                                <th>Anno</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <select id="ultimo-intervento" name="ultimo-intervento">
                                        <option value="">Seleziona intervento...</option>
                                        <option value="Conversione a ceduo">Conversione a ceduo</option>
                                        <option value="Diradamento dal basso">Diradamento dal basso</option>
                                        <option value="Diradamento del ceduo">Diradamento del ceduo</option>
                                        <option value="Diradamento geometrico">Diradamento geometrico</option>
                                        <option value="Diradamento selettivo">Diradamento selettivo</option>
                                        <option value="Manutenzione attorno manufatto">Manutenzione attorno manufatto</option>
                                        <option value="Manutenzione idraulica">Manutenzione idraulica</option>
                                        <option value="Manutenzione lungo viabilit√†">Manutenzione lungo viabilit√†</option>
                                        <option value="Recupero dell'uso agricolo storico del suolo">Recupero dell'uso agricolo storico del suolo</option>
                                        <option value="Sfollo e spalcatura">Sfollo e spalcatura</option>
                                        <option value="Sostituzione di specie">Sostituzione di specie</option>
                                        <option value="Taglio a scelta">Taglio a scelta</option>
                                        <option value="Taglio della fustaia su ceduo">Taglio della fustaia su ceduo</option>
                                        <option value="Taglio del ceduo a sterzo">Taglio del ceduo a sterzo</option>
                                        <option value="Taglio del ceduo composto">Taglio del ceduo composto</option>
                                        <option value="Taglio del ceduo coniferato">Taglio del ceduo coniferato</option>
                                        <option value="Taglio del ceduo intensamente matricinato">Taglio del ceduo intensamente matricinato</option>
                                        <option value="Taglio del ceduo semplice con rilascio di matricine">Taglio del ceduo semplice con rilascio di matricine</option>
                                        <option value="Taglio di avviamento all'alto fusto">Taglio di avviamento all'alto fusto</option>
                                        <option value="Taglio raso della fustaia con rimboschimento artificiale">Taglio raso della fustaia con rimboschimento artificiale</option>
                                        <option value="Taglio saltuario">Taglio saltuario</option>
                                        <option value="Trasformazione da terreno saldo a periodica lavorazione">Trasformazione da terreno saldo a periodica lavorazione</option>
                                        <option value="Altro: dettagliato in descrizione">Altro: dettagliato in descrizione</option>
                                    </select>
                                </td>
                                <td><input type="number" id="ultimo-intervento-anno" name="ultimo-intervento-anno" min="1900" max="2050"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="intervention-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Intervento programmato</th>
                                <th>Superficie (ha)</th>
                                <th>Anno</th>
                                <th>Et√†</th>
                                <th>Provv (mc)</th>
                                <th>Ripresa (mc)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <select>
                                        <option value="">Seleziona intervento...</option>
                                        <option value="Conversione a ceduo">Conversione a ceduo</option>
                                        <option value="Diradamento dal basso">Diradamento dal basso</option>
                                        <option value="Diradamento del ceduo">Diradamento del ceduo</option>
                                        <option value="Diradamento geometrico">Diradamento geometrico</option>
                                        <option value="Diradamento selettivo">Diradamento selettivo</option>
                                        <option value="Manutenzione attorno manufatto">Manutenzione attorno manufatto</option>
                                        <option value="Manutenzione idraulica">Manutenzione idraulica</option>
                                        <option value="Manutenzione lungo viabilit√†">Manutenzione lungo viabilit√†</option>
                                        <option value="Recupero dell'uso agricolo storico del suolo">Recupero dell'uso agricolo storico del suolo</option>
                                        <option value="Sfollo e spalcatura">Sfollo e spalcatura</option>
                                        <option value="Sostituzione di specie">Sostituzione di specie</option>
                                        <option value="Taglio a scelta">Taglio a scelta</option>
                                        <option value="Taglio della fustaia su ceduo">Taglio della fustaia su ceduo</option>
                                        <option value="Taglio del ceduo a sterzo">Taglio del ceduo a sterzo</option>
                                        <option value="Taglio del ceduo composto">Taglio del ceduo composto</option>
                                        <option value="Taglio del ceduo coniferato">Taglio del ceduo coniferato</option>
                                        <option value="Taglio del ceduo intensamente matricinato">Taglio del ceduo intensamente matricinato</option>
                                        <option value="Taglio del ceduo semplice con rilascio di matricine">Taglio del ceduo semplice con rilascio di matricine</option>
                                        <option value="Taglio di avviamento all'alto fusto">Taglio di avviamento all'alto fusto</option>
                                        <option value="Taglio raso della fustaia con rimboschimento artificiale">Taglio raso della fustaia con rimboschimento artificiale</option>
                                        <option value="Taglio saltuario">Taglio saltuario</option>
                                        <option value="Trasformazione da terreno saldo a periodica lavorazione">Trasformazione da terreno saldo a periodica lavorazione</option>
                                        <option value="Altro: dettagliato in descrizione">Altro: dettagliato in descrizione</option>
                                    </select>
                                </td>
                                <td><input type="number" step="0.0001" max="999.9999"></td>
                                <td><input type="number" min="1900" max="2050"></td>
                                <td><input type="number"></td>
                                <td><input type="number" step="0.01" max="9999.99"></td>
                                <td><input type="number" step="0.01" max="9999.99"></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" id="add-intervention" class="add-row-btn">+ Aggiungi intervento</button>
                </div>

                <div class="row">
                    <div class="field-group">
                        <label for="intensita-intervento">Intensit√† intervento</label>
                        <input type="number" step="1" max="99" id="intensita-intervento" name="intensita-intervento">
                    </div>
                    <div class="field-group">
                        <label for="autorizzazione">
                            <input type="checkbox" id="autorizzazione" name="autorizzazione">
                            Autorizzazione
                        </label>
                    </div>
                    <div class="field-group">
                        <label for="deroga">
                            <input type="checkbox" id="deroga" name="deroga">
                            Deroga al regolamento
                        </label>
                    </div>
                </div>
            </section>

            <!-- Riferimenti catastali -->
            <section class="form-section">
                <div class="section-header">Riferimenti catastali</div>
                <div class="cadastral-container">
                    <div class="cadastral-column">
                        <div class="cadastral-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Comune</th>
                                        <th>Foglio</th>
                                        <th>Part</th>
                                        <th>Sup. (ha)</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="cadastral-left-tbody">
                                    <tr>
                                        <td><input type="text"></td>
                                        <td><input type="text"></td>
                                        <td><input type="text"></td>
                                        <td><input type="number" step="0.01"></td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button type="button" id="add-cadastral" class="add-row-btn">+ Aggiungi particella</button>
                        </div>
                    </div>
                    <div class="cadastral-column">
                        <div class="cadastral-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Comune</th>
                                        <th>Foglio</th>
                                        <th>Part</th>
                                        <th>Sup. (ha)</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="cadastral-right-tbody">
                                    <!-- Right column starts empty, populated when left column has 4+ rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Descrizione -->
            <section class="form-section">
                <div class="field-group full-width">
                    <label for="descrizione">Descrizione</label>
                    <textarea id="descrizione" name="descrizione" rows="6" placeholder="Inserire qui eventuali note descrittive..."></textarea>
                </div>
            </section>

            <!-- Pulsanti di controllo -->
            <div class="form-actions">
                <button type="button" id="save-btn" class="btn btn-primary">üíæ Salva</button>
                <button type="button" id="load-btn" class="btn btn-secondary">üìÅ Carica</button>
                <button type="button" id="export-btn" class="btn btn-secondary">üì§ Esporta</button>
                <button type="reset" class="btn btn-danger">üóëÔ∏è Cancella tutto</button>
            </div>
        </form>
    </div>

    <script>
        // Page management
        function showHomePage() {
            document.getElementById('home-page').classList.remove('hidden');
            document.getElementById('project-page').classList.add('hidden');
            document.getElementById('main-form').classList.add('hidden');
        }

        function showProjectPage() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('project-page').classList.remove('hidden');
            document.getElementById('main-form').classList.add('hidden');
            loadProjectData();
        }

        function showMainForm() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('project-page').classList.add('hidden');
            document.getElementById('main-form').classList.remove('hidden');
        }

        function loadProjectData() {
            const projectData = JSON.parse(localStorage.getItem('current-project'));
            if (projectData) {
                document.getElementById('display-project-name').textContent = projectData.name;
                document.getElementById('display-project-location').textContent = projectData.location;
                document.getElementById('display-project-client').textContent = projectData.client;
                document.getElementById('display-project-authority').textContent = projectData.authority;
                loadParticellaCards();
            }
        }

        function loadParticellaCards() {
            const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
            const tableBody = document.getElementById('particella-table-body');
            const emptyMessage = document.getElementById('empty-particelle-message');
            const table = document.querySelector('.particella-table');
            
            tableBody.innerHTML = '';
            
            if (particelleData.length === 0) {
                table.style.display = 'none';
                emptyMessage.style.display = 'flex';
            } else {
                table.style.display = 'table';
                emptyMessage.style.display = 'none';
                
                particelleData.forEach((particella, index) => {
                    const row = document.createElement('tr');
                    row.className = 'particella-row';
                    
                    // Extract PF and SPF data
                    let pfValue = 'Non specificata';
                    let spfValue = 'Non specificata';
                    if (particella.formData) {
                        pfValue = particella.formData['particella'] || 'Non specificata';
                        spfValue = particella.formData['sottoparticella'] || 'Non specificata';
                    }
                    
                    // Extract species data (first species from the form data)
                    let specieName = 'Non specificata';
                    if (particella.formData && particella.formData.species) {
                        specieName = particella.formData.species;
                    }
                    
                    // Extract intervention data
                    let interventoProgr = 'Non specificato';
                    let anno = 'Non specificato';
                    if (particella.formData) {
                        // Check for intervention table data or ultimo intervento
                        interventoProgr = particella.formData['ultimo-intervento'] || 'Non specificato';
                        anno = particella.formData['ultimo-intervento-anno'] || 'Non specificato';
                    }
                    
                    row.innerHTML = `
                        <td class="particella-name">${pfValue}</td>
                        <td class="particella-spf">${spfValue}</td>
                        <td class="particella-superficie">${particella.superficie || 'Non specificata'}</td>
                        <td class="particella-specie">${specieName}</td>
                        <td class="particella-intervento">${interventoProgr}</td>
                        <td class="particella-anno">${anno}</td>
                        <td class="particella-actions">
                            <button class="action-btn edit-btn" onclick="editParticella(${index})" title="Modifica">‚úèÔ∏è</button>
                            <button class="action-btn duplicate-btn" onclick="duplicateParticella(${index})" title="Duplica">üìã</button>
                            <button class="action-btn delete-btn" onclick="deleteParticella(${index})" title="Elimina">üóëÔ∏è</button>
                        </td>
                    `;
                    
                    // Make row clickable (except for action buttons)
                    row.addEventListener('click', function(e) {
                        if (!e.target.classList.contains('action-btn')) {
                            editParticella(index);
                        }
                    });
                    
                    tableBody.appendChild(row);
                });
            }
        }

        // Home page navigation
        document.getElementById('new-project-btn').addEventListener('click', function() {
            document.getElementById('project-modal').classList.remove('hidden');
        });

        document.getElementById('cancel-project-btn').addEventListener('click', function() {
            document.getElementById('project-modal').classList.add('hidden');
            document.getElementById('project-form').reset();
        });

        document.getElementById('start-project-btn').addEventListener('click', function() {
            const form = document.getElementById('project-form');
            if (form.checkValidity()) {
                // Save project data
                const projectData = {
                    name: document.getElementById('project-name').value,
                    location: document.getElementById('project-location').value,
                    client: document.getElementById('project-client').value,
                    authority: document.getElementById('project-authority').value,
                    createdAt: new Date().toISOString()
                };
                
                localStorage.setItem('current-project', JSON.stringify(projectData));
                localStorage.setItem('project-' + Date.now(), JSON.stringify(projectData));
                
                // Close modal and show project page
                document.getElementById('project-modal').classList.add('hidden');
                showProjectPage();
            } else {
                alert('Compilare tutti i campi richiesti.');
            }
        });

        // Placeholder functions for other buttons
        document.getElementById('load-project-btn').addEventListener('click', function() {
            alert('Funzionalit√† "Carica progetto" in sviluppo');
        });

        document.getElementById('manage-projects-btn').addEventListener('click', function() {
            alert('Funzionalit√† "Gestione progetti" in sviluppo');
        });

        document.getElementById('settings-btn').addEventListener('click', function() {
            alert('Funzionalit√† "Impostazioni" in sviluppo');
        });

        document.getElementById('guide-btn').addEventListener('click', function() {
            alert('Funzionalit√† "Guida" in sviluppo');
        });

        // Close modal when clicking outside
        document.getElementById('project-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
                document.getElementById('project-form').reset();
            }
        });

        // Project page navigation
        document.getElementById('back-to-home-btn').addEventListener('click', function() {
            showHomePage();
        });

        document.getElementById('add-particella-btn').addEventListener('click', function() {
            createNewParticella();
        });

        // Particella management functions
        function createNewParticella() {
            const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
            const newParticella = {
                id: Date.now(),
                createdAt: new Date().toISOString(),
                localita: '',
                superficie: ''
            };
            
            // Store current particella index for editing
            localStorage.setItem('current-particella-index', particelleData.length.toString());
            particelleData.push(newParticella);
            localStorage.setItem('project-particelle', JSON.stringify(particelleData));
            
            // Navigate to form for editing the new particella
            showMainForm();
        }

        function editParticella(index) {
            localStorage.setItem('current-particella-index', index.toString());
            showMainForm();
        }

        function duplicateParticella(index) {
            const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
            const originalParticella = particelleData[index];
            
            if (originalParticella) {
                const duplicatedParticella = {
                    ...originalParticella,
                    id: Date.now(),
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                particelleData.push(duplicatedParticella);
                localStorage.setItem('project-particelle', JSON.stringify(particelleData));
                loadParticellaCards();
                
                // Show confirmation
                alert('Particella duplicata con successo!');
            }
        }

        function deleteParticella(index) {
            if (confirm('Sei sicuro di voler eliminare questa particella?')) {
                const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
                particelleData.splice(index, 1);
                localStorage.setItem('project-particelle', JSON.stringify(particelleData));
                loadParticellaCards();
            }
        }

        // Add back to project button in main form
        function addBackToProjectButton() {
            const formHeader = document.querySelector('.form-header');
            if (formHeader && !document.getElementById('back-to-project-btn')) {
                const backBtn = document.createElement('button');
                backBtn.id = 'back-to-project-btn';
                backBtn.type = 'button';
                backBtn.className = 'back-btn';
                backBtn.innerHTML = '‚Üê Torna al progetto';
                backBtn.addEventListener('click', function() {
                    // Save current form data before going back
                    const formData = new FormData(document.getElementById('forestry-form'));
                    const data = Object.fromEntries(formData);
                    const particellaIndex = localStorage.getItem('current-particella-index');
                    
                    if (particellaIndex !== null) {
                        const particelleData = JSON.parse(localStorage.getItem('project-particelle') || '[]');
                        if (particelleData[parseInt(particellaIndex)]) {
                            // Update particella data with form values
                            particelleData[parseInt(particellaIndex)] = {
                                ...particelleData[parseInt(particellaIndex)],
                                localita: data.localita || '',
                                superficie: data['superficie-particella'] || '',
                                formData: data,
                                lastModified: new Date().toISOString()
                            };
                            localStorage.setItem('project-particelle', JSON.stringify(particelleData));
                        }
                    }
                    
                    showProjectPage();
                });
                formHeader.appendChild(backBtn);
            }
        }

        // Initialize back button when form is shown
        const originalShowMainForm = showMainForm;
        showMainForm = function() {
            originalShowMainForm();
            setTimeout(() => addBackToProjectButton(), 100);
        };

        // Registrazione del Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registrato con successo: ', registration.scope);
                    }, function(err) {
                        console.log('ServiceWorker registrazione fallita: ', err);
                    });
            });
        }

        // Funzionalit√† per aggiungere infrastrutture
        document.getElementById('add-infrastruttura-btn').addEventListener('click', function() {
            const container = document.querySelector('.infrastructure-container');
            const newFieldGroup = document.createElement('div');
            newFieldGroup.className = 'field-group';
            newFieldGroup.innerHTML = `
                <div class="input-with-delete">
                    <select name="viabilita-extra">
                        <option value="">Seleziona...</option>
                        <option value="Strada camionabile principale">Strada camionabile principale</option>
                        <option value="Strada camionabile secondaria">Strada camionabile secondaria</option>
                        <option value="Strada trattorabile">Strada trattorabile</option>
                        <option value="Pista camionabile">Pista camionabile</option>
                        <option value="Pista principale per trattori">Pista principale per trattori</option>
                        <option value="Pista secondaria per trattori">Pista secondaria per trattori</option>
                        <option value="Linee di esbosco">Linee di esbosco</option>
                        <option value="Imposto permanente">Imposto permanente</option>
                        <option value="Imposto temporaneo">Imposto temporaneo</option>
                    </select>
                    <button type="button" class="delete-row-btn" onclick="deleteInfrastructureRow(this)" title="Elimina">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(newFieldGroup);
        });

        // Funzione per eliminare righe infrastruttura
        function deleteInfrastructureRow(button) {
            const fieldGroup = button.closest('.field-group');
            fieldGroup.remove();
        }

        // Funzionalit√† per aggiungere righe specie
        document.getElementById('add-species').addEventListener('click', function() {
            const tbody = document.querySelector('.species-table tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td>
                    <select>
                        <option value="">Seleziona specie...</option>
                        <option value="Abete bianco (Abies alba)">Abete bianco <em>(Abies alba)</em></option>
                        <option value="Abete rosso (Picea abies)">Abete rosso <em>(Picea abies)</em></option>
                        <option value="Acero campestre (Acer campestre)">Acero campestre <em>(Acer campestre)</em></option>
                        <option value="Acero di monte (Acer pseudoplatanus)">Acero di monte <em>(Acer pseudoplatanus)</em></option>
                        <option value="Acero opalo (Acer opalus)">Acero opalo <em>(Acer opalus)</em></option>
                        <option value="Acero riccio (Acer lobelii)">Acero riccio <em>(Acer lobelii)</em></option>
                        <option value="Acero tribolo (Acer tataricum)">Acero tribolo <em>(Acer tataricum)</em></option>
                        <option value="Ailanto (Ailanthus altissima)">Ailanto <em>(Ailanthus altissima)</em></option>
                        <option value="Betulla (Betula pendula)">Betulla <em>(Betula pendula)</em></option>
                        <option value="Carpino bianco (Carpinus betulus)">Carpino bianco <em>(Carpinus betulus)</em></option>
                        <option value="Carpino nero (Ostrya carpinifolia)">Carpino nero <em>(Ostrya carpinifolia)</em></option>
                        <option value="Castagno (Castanea sativa)">Castagno <em>(Castanea sativa)</em></option>
                        <option value="Cedro dell'Atlante (Cedrus atlantica)">Cedro dell'Atlante <em>(Cedrus atlantica)</em></option>
                        <option value="Cedro deodara (Cedrus deodara)">Cedro deodara <em>(Cedrus deodara)</em></option>
                        <option value="Cedro del Libano (Cedrus libani)">Cedro del Libano <em>(Cedrus libani)</em></option>
                        <option value="Cerro (Quercus cerris)">Cerro <em>(Quercus cerris)</em></option>
                        <option value="Chamaecyparis (Chamaecyparis sp)">Chamaecyparis <em>(Chamaecyparis sp)</em></option>
                        <option value="Ciavardello (Quercus robur)">Ciavardello <em>(Quercus robur)</em></option>
                        <option value="Ciliegio (Prunus avium)">Ciliegio <em>(Prunus avium)</em></option>
                        <option value="Cipresso comune (Cupressus sempervirens)">Cipresso comune <em>(Cupressus sempervirens)</em></option>
                        <option value="Cipresso dell'Arizona (Cupressus arizonica)">Cipresso dell'Arizona <em>(Cupressus arizonica)</em></option>
                        <option value="Cipresso di Monterey (Cupressus macrocarpa)">Cipresso di Monterey <em>(Cupressus macrocarpa)</em></option>
                        <option value="Corbezzolo (Arbutus unedo)">Corbezzolo <em>(Arbutus unedo)</em></option>
                        <option value="Douglasia (Pseudotsuga menziesii)">Douglasia <em>(Pseudotsuga menziesii)</em></option>
                        <option value="Faggio (Fagus sylvatica)">Faggio <em>(Fagus sylvatica)</em></option>
                        <option value="Farnetto (Fraxinus ornus)">Farnetto <em>(Fraxinus ornus)</em></option>
                        <option value="Farnia (Fraxinus excelsior)">Farnia <em>(Fraxinus excelsior)</em></option>
                        <option value="Frassino maggiore (Fraxinus angustifolia)">Frassino maggiore <em>(Fraxinus angustifolia)</em></option>
                        <option value="Frassino ossifillo (Fraxinus oxycarpa)">Frassino ossifillo <em>(Fraxinus oxycarpa)</em></option>
                        <option value="Ippocastano (Aesculus hippocastanum)">Ippocastano <em>(Aesculus hippocastanum)</em></option>
                        <option value="Leccio (Quercus ilex)">Leccio <em>(Quercus ilex)</em></option>
                        <option value="Nocciolo (Corylus avellana)">Nocciolo <em>(Corylus avellana)</em></option>
                        <option value="Noce (Juglans regia)">Noce <em>(Juglans regia)</em></option>
                        <option value="Ontano bianco (Alnus incana)">Ontano bianco <em>(Alnus incana)</em></option>
                        <option value="Ontano napoletano (Alnus cordata)">Ontano napoletano <em>(Alnus cordata)</em></option>
                        <option value="Ontano nero (Alnus glutinosa)">Ontano nero <em>(Alnus glutinosa)</em></option>
                        <option value="Orniello (Fraxinus ornus)">Orniello <em>(Fraxinus ornus)</em></option>
                        <option value="Pino d'Aleppo (Pinus halepensis)">Pino d'Aleppo <em>(Pinus halepensis)</em></option>
                        <option value="Pino domestico (Pinus pinea)">Pino domestico <em>(Pinus pinea)</em></option>
                        <option value="Pino insigne (Pinus radiata)">Pino insigne <em>(Pinus radiata)</em></option>
                        <option value="Pino loricato (Pinus heldreichii)">Pino loricato <em>(Pinus heldreichii)</em></option>
                        <option value="Pino marittimo (Pinus pinaster)">Pino marittimo <em>(Pinus pinaster)</em></option>
                        <option value="Pino nero (Pinus nigra)">Pino nero <em>(Pinus nigra)</em></option>
                        <option value="Pino silvestre (Pinus sylvestris)">Pino silvestre <em>(Pinus sylvestris)</em></option>
                        <option value="Pioppo bianco (Populus alba)">Pioppo bianco <em>(Populus alba)</em></option>
                        <option value="Pioppo cinerino (Populus cinerea)">Pioppo cinerino <em>(Populus cinerea)</em></option>
                        <option value="Pioppo nero (Populus nigra)">Pioppo nero <em>(Populus nigra)</em></option>
                        <option value="Pioppo tremulo (Populus tremula)">Pioppo tremulo <em>(Populus tremula)</em></option>
                        <option value="Robinia (Robinia pseudoacacia)">Robinia <em>(Robinia pseudoacacia)</em></option>
                        <option value="Rovere (Quercus robur)">Rovere <em>(Quercus robur)</em></option>
                        <option value="Roverella (Quercus petraea)">Roverella <em>(Quercus petraea)</em></option>
                        <option value="Salice (Salix spp)">Salice <em>(Salix spp)</em></option>
                        <option value="Sorbo degli uccellatori (Sorbus aucuparia)">Sorbo degli uccellatori <em>(Sorbus aucuparia)</em></option>
                        <option value="Sorbo domestico (Sorbus domestica)">Sorbo domestico <em>(Sorbus domestica)</em></option>
                        <option value="Sughera (Quercus suber)">Sughera <em>(Quercus suber)</em></option>
                        <option value="Tasso (Taxus baccata)">Tasso <em>(Taxus baccata)</em></option>
                        <option value="Thuja (Thuja occidentalis)">Thuja <em>(Thuja occidentalis)</em></option>
                        <option value="Tiglio (Tilia cordata)">Tiglio <em>(Tilia cordata)</em></option>
                    </select>
                </td>
                <td><input type="number" step="1" max="99" class="no-spinner"></td>
                <td><input type="number" step="1" max="999" class="no-spinner"></td>
                <td><input type="number" step="1" max="999" class="no-spinner"></td>
                <td><input type="number" step="0.01" max="9999.99"></td>
                <td><input type="number" step="0.01"></td>
                <td><button type="button" class="delete-row-btn" onclick="deleteSpeciesRow(this)">üóëÔ∏è</button></td>
            `;
        });

        // Funzionalit√† per aggiungere righe intervento
        document.getElementById('add-intervention').addEventListener('click', function() {
            const tbody = document.querySelector('.intervention-table tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td>
                    <select>
                        <option value="">Seleziona intervento...</option>
                        <option value="Conversione a ceduo">Conversione a ceduo</option>
                        <option value="Diradamento dal basso">Diradamento dal basso</option>
                        <option value="Diradamento del ceduo">Diradamento del ceduo</option>
                        <option value="Diradamento geometrico">Diradamento geometrico</option>
                        <option value="Diradamento selettivo">Diradamento selettivo</option>
                        <option value="Manutenzione attorno manufatto">Manutenzione attorno manufatto</option>
                        <option value="Manutenzione idraulica">Manutenzione idraulica</option>
                        <option value="Manutenzione lungo viabilit√†">Manutenzione lungo viabilit√†</option>
                        <option value="Recupero dell'uso agricolo storico del suolo">Recupero dell'uso agricolo storico del suolo</option>
                        <option value="Sfollo e spalcatura">Sfollo e spalcatura</option>
                        <option value="Sostituzione di specie">Sostituzione di specie</option>
                        <option value="Taglio a scelta">Taglio a scelta</option>
                        <option value="Taglio della fustaia su ceduo">Taglio della fustaia su ceduo</option>
                        <option value="Taglio del ceduo a sterzo">Taglio del ceduo a sterzo</option>
                        <option value="Taglio del ceduo composto">Taglio del ceduo composto</option>
                        <option value="Taglio del ceduo coniferato">Taglio del ceduo coniferato</option>
                        <option value="Taglio del ceduo intensamente matricinato">Taglio del ceduo intensamente matricinato</option>
                        <option value="Taglio del ceduo semplice con rilascio di matricine">Taglio del ceduo semplice con rilascio di matricine</option>
                        <option value="Taglio di avviamento all'alto fusto">Taglio di avviamento all'alto fusto</option>
                        <option value="Taglio raso della fustaia con rimboschimento artificiale">Taglio raso della fustaia con rimboschimento artificiale</option>
                        <option value="Taglio saltuario">Taglio saltuario</option>
                        <option value="Trasformazione da terreno saldo a periodica lavorazione">Trasformazione da terreno saldo a periodica lavorazione</option>
                        <option value="Altro: dettagliato in descrizione">Altro: dettagliato in descrizione</option>
                    </select>
                </td>
                <td><input type="number" step="0.0001" max="999.9999"></td>
                <td><input type="number" min="1900" max="2050"></td>
                <td><input type="number"></td>
                <td><input type="number" step="0.01" max="9999.99"></td>
                <td><input type="number" step="0.01" max="9999.99"></td>
                <td><button type="button" class="delete-row-btn" onclick="deleteInterventionRow(this)">üóëÔ∏è</button></td>
            `;
        });

        // Funzione per eliminare righe specie
        function deleteSpeciesRow(button) {
            const row = button.closest('tr');
            row.remove();
        }

        // Funzione per eliminare righe intervento
        function deleteInterventionRow(button) {
            const row = button.closest('tr');
            row.remove();
        }

        // Funzionalit√† per aggiungere particelle catastali
        document.getElementById('add-cadastral').addEventListener('click', function() {
            const leftTbody = document.getElementById('cadastral-left-tbody');
            const rightTbody = document.getElementById('cadastral-right-tbody');
            const leftRowCount = leftTbody.children.length;
            const rightRowCount = rightTbody.children.length;
            const totalRows = leftRowCount + rightRowCount;

            let targetTbody;
            let showDeleteBtn = false;

            // Logic for row distribution:
            // Rows 1-4: Left column
            // Rows 5-8: Right column
            // Row 9: Move 5th from right to left (left=5, right=4), add 9th to right (left=5, right=5)
            // Row 10: Add to right (left=5, right=6)
            // Row 11: Move 6th from right to left (left=6, right=5), add 11th to right (left=6, right=6)
            // Pattern: When adding odd-numbered rows ‚â•9, move one from right to left first

            if (totalRows >= 8 && (totalRows + 1) % 2 === 1) {
                // For 9th, 11th, 13th... rows: move one row from right to left first
                if (rightRowCount > 4) {
                    const rowToMove = rightTbody.children[0]; // Move the first row from right
                    leftTbody.appendChild(rowToMove);
                }
            }

            // Determine where to add the new row
            const updatedLeftCount = leftTbody.children.length;
            const updatedRightCount = rightTbody.children.length;

            if (updatedLeftCount < 4) {
                targetTbody = leftTbody;
                showDeleteBtn = totalRows >= 1; // Show delete button for 2nd row and beyond
            } else {
                targetTbody = rightTbody;
                showDeleteBtn = true;
            }

            const newRow = targetTbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="number" step="0.01"></td>
                ${showDeleteBtn ? '<td><button type="button" class="delete-row-btn" onclick="deleteCadastralRow(this)">üóëÔ∏è</button></td>' : '<td></td>'}
            `;
        });

        // Funzione per eliminare righe catastali
        function deleteCadastralRow(button) {
            const row = button.closest('tr');
            row.remove();
        }

        // Salvataggio dati nel localStorage
        document.getElementById('save-btn').addEventListener('click', function() {
            const formData = new FormData(document.getElementById('forestry-form'));
            const data = Object.fromEntries(formData);
            localStorage.setItem('forestry-survey-' + Date.now(), JSON.stringify(data));
            alert('Dati salvati con successo!');
        });

        // Validazione decimali per superficie
        function validateDecimals(inputElement) {
            const value = inputElement.value;
            if (value && value.includes('.')) {
                const decimals = value.split('.')[1];
                if (decimals && decimals.length > 4) {
                    alert('Errore: Sono consentiti massimo 4 decimali per i campi superficie');
                    inputElement.value = parseFloat(value).toFixed(4);
                }
            }
        }

        document.getElementById('superficie-particella').addEventListener('blur', function() {
            validateDecimals(this);
        });

        document.getElementById('superficie-sottoparticella').addEventListener('blur', function() {
            validateDecimals(this);
        });

        // Auto-save ogni 30 secondi
        setInterval(function() {
            const formData = new FormData(document.getElementById('forestry-form'));
            const data = Object.fromEntries(formData);
            localStorage.setItem('forestry-survey-autosave', JSON.stringify(data));
        }, 30000);

        // Caricamento dati salvati
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('forestry-survey-autosave');
            if (savedData) {
                const data = JSON.parse(savedData);
                Object.keys(data).forEach(key => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        element.value = data[key];
                    }
                });
            }
        });
    </script>
</body>
</html>